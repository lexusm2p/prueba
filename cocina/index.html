
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><title>Cocina ¬∑ Seven de Burgers</title><link rel="stylesheet" href="../assets/styles.css"></head>
<body>
  <div class="header"><div class="logo">üçî Seven de Burgers <span class="badge">Cocina</span></div><div class="row"><a class="btn secondary" href="../login/index.html">Login</a></div></div>
  <div class="container">
    <div class="columns"><section><h3>Pendientes</h3><div id="list-pending"></div></section><section><h3>En preparaci√≥n</h3><div id="list-progress"></div></section><section><h3>Listos</h3><div id="list-ready"></div></section></div>
  </div>
  <script type="module">
    import {subscribeOrders, setStatus, archiveDelivered, Status} from '../shared/state.smart.js';
    const listPending=document.getElementById('list-pending'), listProgress=document.getElementById('list-progress'), listReady=document.getElementById('list-ready');
    const pillClass=s=>({pending:'pill--pending',in_progress:'pill--in_progress',ready:'pill--ready'})[s]||'pill--pending';
    const pillText=s=>({pending:'Pendiente',in_progress:'En preparaci√≥n',ready:'Listo'})[s]||s;
    function card(o){
      const ing=Array.isArray(o.ingredientesFinales)?o.ingredientesFinales.join(' ¬∑ '):'‚Äî';
      const ad=(o.aderezos||[]).join(', ')||'‚Äî'; const ex=(o.extras||[]).join(', ')||'‚Äî';
      return `<article class="k-card" data-id="${o.id}">
        <header><strong>${o.customer||'Cliente'}</strong> ¬∑ Mesa ${o.table||'-'} <span class="pill ${pillClass(o.status)}">${pillText(o.status)}</span></header>
        <div class="small"><b>${o.burgerName}</b> √ó ${o.qty||1}</div>
        <div class="small"><b>Ingredientes:</b> ${ing}</div>
        <div class="small"><b>Aderezos extra:</b> ${ad}</div>
        <div class="small"><b>Extras:</b> ${ex}</div>
        <div class="small"><b>Notas:</b> ${o.notes||'‚Äî'}</div>
        <div class="k-actions">
          ${o.status==='pending' ? '<button class="k-btn k-primary" data-a="take">Tomar</button>' : ''}
          ${o.status==='in_progress' ? '<button class="k-btn k-primary" data-a="ready">Listo</button>' : ''}
          ${o.status==='ready' ? '<button class="k-btn k-success" data-a="deliver">Despachado</button>' : ''}
        </div>
      </article>`;
    }
    function render(list){
      const p=list.filter(o=>o.status===Status.PENDING);
      const ip=list.filter(o=>o.status===Status.IN_PROGRESS);
      const r=list.filter(o=>o.status===Status.READY);
      listPending.innerHTML = p.map(card).join('') || '<div class="empty">Sin pendientes</div>';
      listProgress.innerHTML = ip.map(card).join('') || '<div class="empty">Sin preparaci√≥n</div>';
      listReady.innerHTML = r.map(card).join('') || '<div class="empty">Sin listos</div>';
    }
    subscribeOrders(render);
    document.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button[data-a]'); if(!btn) return;
      const id=btn.closest('.k-card')?.dataset.id; if(!id) return; const a=btn.dataset.a;
      if(a==='take') await setStatus(id, Status.IN_PROGRESS);
      if(a==='ready') await setStatus(id, Status.READY);
      if(a==='deliver') await archiveDelivered(id);
    });
  </script>
  <footer>Backend: <span id="bk">‚Äî</span></footer>
  <script type="module">import {backendName} from '../shared/state.smart.js'; document.getElementById('bk').textContent=backendName;</script>
</body></html>
      listProgress.innerHTML = ip.map(card).join('') || '<div class="empty">Sin preparaci√≥n</div>';
      listReady.innerHTML = r.map(card).join('') || '<div class="empty">Sin listos</div>';
    }
    subscribeOrders(render);
    document.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button[data-a]'); if(!btn) return;
      const id=btn.closest('.k-card')?.dataset.id; if(!id) return; const a=btn.dataset.a;
      if(a==='take') await setStatus(id, Status.IN_PROGRESS);
      if(a==='ready') await setStatus(id, Status.READY);
      if(a==='deliver') await archiveDelivered(id);
    });
  </script>
  <footer>Backend: <span id="bk">‚Äî</span></footer>
  <script type="module">import {backendName} from '../shared/state.smart.js'; document.getElementById('bk').textContent=backendName;</script>
</body></html>
  <script type="module">
    import {BURGERS, ADEREZOS, EXTRAS, REMOVIBLES} from '../shared/menu.js';
    import * as state from '../shared/state.smart.js';
    const {addOrder} = state;
    const grid=document.getElementById('grid'), modal=document.getElementById('modal'), backdrop=document.getElementById('backdrop');
    const ttl=document.getElementById('ttl'), inpCliente=document.getElementById('inpCliente'), inpQty=document.getElementById('inpQty');
    const lblTotal=document.getElementById('lblTotal'), listAd=document.getElementById('listAd'), listEx=document.getElementById('listEx'), listRm=document.getElementById('listRm');
    const lblRec=document.getElementById('lblRec'), chkRec=document.getElementById('chkRec'), txtNotas=document.getElementById('txtNotas'), toast=document.getElementById('toast');
    const btnConfirm=document.getElementById('btnConfirm'), btnClose=document.getElementById('mClose');
    let current=null, recId=null, adSet=new Set(), exSet=new Set(), rmSet=new Set();
    function card(b){return `<div class="card"><div class="small">Sugerida base: ${b.suggestedBase}</div><h3>${b.name}</h3><div class="small">${b.ingredients.join(' ¬∑ ')}</div><div class="row" style="margin-top:10px"><div class="price">$${b.price}</div><span style="flex:1"></span><button class="btn" data-id="${b.id}">Ordenar</button></div></div>`}
    function renderMenu(){ grid.innerHTML=BURGERS.map(card).join(''); grid.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click',()=>openModal(b.dataset.id))); }
    function openModal(id){
      current=BURGERS.find(x=>x.id===id); adSet.clear(); exSet.clear(); rmSet.clear(); inpCliente.value=''; inpQty.value=1; txtNotas.value='';
      const base=(current.suggestedBase||'').toLowerCase(); const deny=new Set(base.split(/\s*\+\s*/)); const recs=(current.recommended||[]).filter(r=>!deny.has(r)); recId=recs[0]||null;
      lblRec.textContent= recId ? (ADEREZOS.find(a=>a.id===recId)?.name || 'Sorpresa') : 'Sorpresa'; chkRec.checked=!!recId;
      ttl.textContent = `${current.name} ¬∑ $${current.price}`;
      listAd.innerHTML = ADEREZOS.map(a=>`<label class="item"><input type="checkbox" data-t="ad" data-id="${a.id}"><div class="meta">${a.name}</div><div class="cost">+$${a.price}</div></label>`).join('');
      listEx.innerHTML = EXTRAS.map(e=>`<label class="item"><input type="checkbox" data-t="ex" data-id="${e.id}"><div class="meta">${e.name}</div><div class="cost">+$${e.price}</div></label>`).join('');
      listRm.innerHTML = REMOVIBLES.map(r=>`<label class="item"><input type="checkbox" data-t="rm" data-id="${r}"><div class="meta">Quitar: ${r}</div></label>`).join('');
      modal.style.display='block'; backdrop.style.display='block'; bind(); calcTotal();
    }
    function closeModal(){ modal.style.display='none'; backdrop.style.display='none'; }
    function bind(){ modal.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ ch.addEventListener('change',(e)=>{
      const t=e.target.dataset.t, id=e.target.dataset.id; if(t==='ad'){e.target.checked?adSet.add(id):adSet.delete(id);} if(t==='ex'){e.target.checked?exSet.add(id):exSet.delete(id);} if(t==='rm'){e.target.checked?rmSet.add(id):rmSet.delete(id);} calcTotal(); })}); inpQty.addEventListener('input',calcTotal); document.getElementById('mClose').addEventListener('click',closeModal); }
    function priceAd(id){ return ADEREZOS.find(a=>a.id===id)?.price||0 } function priceEx(id){ return EXTRAS.find(e=>e.id===id)?.price||0 }
    function calcTotal(){ if(!current) return; const qty=Math.max(1,parseInt(inpQty.value||'1',10)); let extra=0; if(chkRec.checked && recId && !adSet.has(recId)) extra+=priceAd(recId); for(const id of adSet) extra+=priceAd(id); for(const id of exSet) extra+=priceEx(id); lblTotal.textContent='$'+(qty*(current.price+extra)); }
    btnConfirm.addEventListener('click', async ()=>{
      const qty=Math.max(1,parseInt(inpQty.value||'1',10)); const ad=new Set(adSet); if(chkRec.checked && recId) ad.add(recId);
      const finalIngs=current.ingredients.filter(x=>!rmSet.has(x.split(' ')[0]));
      await addOrder({ type:'kiosk', burgerId:current.id, burgerName:current.name, priceUnit:current.price, qty, customer:(inpCliente.value||'Cliente').trim(), recommendedApplied:!!(chkRec.checked&&recId), recommendedId:recId, aderezos:[...ad], extras:[...exSet], remove:[...rmSet], notes:txtNotas.value.trim(), ingredientesFinales:finalIngs });
      closeModal(); const t=document.getElementById('toast'); t.textContent='Pedido enviado'; t.style.display='block'; setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show'); t.style.display='none'},1800);
    });
    renderMenu();
  </script>
  <footer>Backend: <span id="bk">‚Äî</span></footer>
  <script type="module">
    import {backendName} from '../shared/state.smart.js';
    document.getElementById('bk').textContent = backendName;
  </script>
</body>
</html>
      listProgress.innerHTML = ip.map(card).join('') || '<div class="empty">Sin preparaci√≥n</div>';
      listReady.innerHTML = r.map(card).join('') || '<div class="empty">Sin listos</div>';
    }
    subscribeOrders(render);
    document.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button[data-a]'); if(!btn) return;
      const id=btn.closest('.k-card')?.dataset.id; if(!id) return; const a=btn.dataset.a;
      if(a==='take') await setStatus(id, Status.IN_PROGRESS);
      if(a==='ready') await setStatus(id, Status.READY);
      if(a==='deliver') await archiveDelivered(id);
    });
  </script>
  <footer>Backend: <span id="bk">‚Äî</span></footer>
  <script type="module">import {backendName} from '../shared/state.smart.js'; document.getElementById('bk').textContent=backendName;</script>
</body></html>
          const removed = o.remove||[];
          const finalIng = baseIng.filter(i=>!removed.includes(i));
          const adLabels = (o.aderezos||[]).map(id=>byId(ADEREZOS,id)?.name||id);
          const exLabels = (o.extras||[]).map(id=>byId(EXTRAS,id)?.name||id);
          return `<div class="card">
            <div class="kicker">#${o.id.slice(-5)} ¬∑ ${new Date(o.createdAt).toLocaleTimeString()}</div>
            <h3>${o.burgerName||'-'} √ó ${o.qty||1}</h3>
            <div class="small"><strong>Ingredientes:</strong> ${finalIng.join(' ¬∑ ')}</div>
            <div class="small"><strong>Aderezos extra:</strong> ${adLabels.join(', ') || '‚Äî'}</div>
            <div class="small"><strong>Extras:</strong> ${exLabels.join(', ') || '‚Äî'}</div>
            <div class="small"><strong>Salsa sugerida:</strong> ${o.suggestedApplied ? (o.suggestedName||'‚Äî') : 'No aplicada'}</div>
            <div class="small"><strong>Notas:</strong> ${o.notes||'‚Äî'}</div>
            <div class="row" style="margin-top:8px">
              <span class="chip">${o.customer||'Cliente'}</span>
              ${o.table?'<span class="chip">Mesa '+o.table+'</span>':''}
              <span style="flex:1"></span>
              ${o.status!=='en_proceso'?'<button class="btn secondary" data-a="proc" data-id="'+o.id+'">En proceso</button>':''}
              ${o.status!=='listo'?'<button class="btn" data-a="ready" data-id="'+o.id+'">Listo</button>':''}
            </div>
          </div>;
        }).join('');

      grid.querySelectorAll('button[data-id]').forEach(b=>{
        const id = b.dataset.id, a = b.dataset.a;
        b.addEventListener('click', ()=>{
          Storage.updateOrder(id, {status: a==='proc' ? 'en_proceso' : 'listo'});
        });
      });
    }

    const unsub = Storage.subscribeOrders(render);
  </script>
</body>
</html>
