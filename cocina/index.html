<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cocina ¬∑ Seven de Burgers</title>
<style>
  :root{--bg:#0f2333;--pane:#0e2231;--col:#12324a;--line:#1a3f56;--text:#eaf6ff;--muted:#a9cbe0;--accent:#ffcc33;--ok:#35d07f;--warn:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--pane)}
  .brand{font-weight:900}
  .wrap{max-width:1200px;margin:0 auto;padding:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .col{background:var(--col);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .col h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:15px;color:#cfe9f7}
  .list{padding:10px;display:flex;flex-direction:column;gap:10px;min-height:60vh}
  .card{background:var(--pane);border:1px solid var(--line);border-radius:12px;padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{background:#0b2a3d;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
  .meta{color:var(--muted);font-size:12px}
  button{cursor:pointer;border:0;border-radius:10px;padding:8px 10px;font-weight:800}
  .b{background:#0b2a3d;color:#cfe9f7;border:1px solid var(--line)}
  .b-ok{background:var(--ok);color:#052f1a}
  .b-warn{background:var(--warn);color:#2b1900}
  .right{margin-left:auto}
  a.btn{color:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="brand">üë®‚Äçüç≥ Cocina ‚Äî Seven de Burgers</div>
  <nav class="row">
    <a class="btn" href="../kiosk/index.html">Ir al kiosko</a>
    <a class="btn" href="../mesero/index.html">Ir a mesero</a>
  </nav>
</header>
<header class="bar">
  <a class="brand" href="/prueba/kiosk/">Seven de Burgers</a>
  <nav class="links">
    <a href="/prueba/kiosk/">Ir al kiosko</a>
    <a href="/prueba/mesero/">Ir a mesero</a>
  </nav>
</header>
<main class="wrap">
  <section class="col"><h3>Sin pendientes</h3><div id="col-pending" class="list"></div></section>
  <section class="col"><h3>En preparaci√≥n</h3><div id="col-progress" class="list"></div></section>
  <section class="col"><h3>Listos</h3><div id="col-ready" class="list"></div></section>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDoc, setDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

const config = {
  apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
  authDomain: "seven-de-burgers.firebaseapp.com",
  projectId: "seven-de-burgers",
  storageBucket: "seven-de-burgers.firebasestorage.app",
  messagingSenderId: "34089845279",
  appId: "1:34089845279:web:d13440c34e6bb7fa910b2a",
  measurementId: "G-Q8YQJGL2XY"
};
const app = initializeApp(config);
const db  = getFirestore(app);

/* referencia de ingredientes base por id (por si la orden no lo trae) */
const MAP_ING = {
  starter:'Pan, Carne 85g, Queso amarillo, Queso blanco, Lechuga, Jitomate, Cebolla, Mayonesa, Catsup, Mostaza',
  koopa:'Pan, Carne, Queso blanco, Pi√±a, Tocino, Lechuga, Jitomate, Cebolla, Mayonesa, Catsup, Mostaza',
  flame:'Pan, Carne, Salsa Cheddar, Tocino, Salsa habanero, Lechuga, Jitomate, Cebolla, Mayonesa, Catsup, Mostaza',
  megabyte:'Pan, Carne, Salsa Cheddar, Queso blanco, Tocino, Salchicha, Lechuga, Jitomate, Cebolla, Mayonesa, Catsup',
  hadouken:'Pan, Carne, Queso blanco, Queso amarillo, Salchicha, Aderezo chipotle, Lechuga, Jitomate, Cebolla',
  nintendo:'Pan, Carne, Queso blanco, Pi√±a, Jam√≥n, Lechuga, Jitomate, Cebolla, Mayonesa, Catsup, Mostaza',
  boss:'Pan, Carne, Salsa Cheddar, Queso blanco, Queso amarillo, Tocino, Jam√≥n, Salchicha, Pi√±a, Salsa habanero, Aderezo chipotle'
};

/* beep */
function beep(ms=160,f=820){try{const a=new (window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='square';o.frequency.value=f;g.gain.value=.06;o.start();setTimeout(()=>{o.stop();a.close()},ms);}catch(_){}}

/* render */
const $p = document.getElementById('col-pending');
const $g = document.getElementById('col-progress');
const $r = document.getElementById('col-ready');

function card(id, o){
  const it = o.items?.[0]||{};
  const base = it.baseIngredients || MAP_ING[it.burgerId] || '';
  const ads  = (it.extras?.aderezos||[]).map(x=>x.name);
  const exs  = (it.extras?.ingredientes||[]).map(x=>x.name);
  const chips = (base? base.split(',').map(s=>s.trim()):[]).map(s=>`<span class="chip">${s}</span>`).join('');
  const chipsEx = [...ads, ...exs].map(s=>`<span class="chip">${s}</span>`).join('');
  const who = `${o.customerName?o.customerName+' ¬∑ ':''}${o.table||'Mostrador'}`;
  return `
  <article class="card" data-id="${id}">
    <div class="row">
      <strong>${it.name||'Burger'}</strong> √ó ${it.qty||1}
      <span class="meta right">${who}</span>
    </div>
    ${o.notes?`<div class="meta">Notas: ${o.notes}</div>`:''}
    <div class="chips">${chips}</div>
    ${chipsEx?`<div class="chips" style="margin-top:6px">${chipsEx}</div>`:''}
    <div class="row" style="margin-top:8px">
      ${o.status==='PENDING' ? `
        <button class="b b-warn" data-a="take">Tomar</button>
      `:''}
      ${o.status==='IN_PROGRESS' ? `
        <button class="b b-ok" data-a="ready">Listo</button>
      `:''}
      ${o.status==='READY' ? `
        <span class="meta ok">Listo para entregar</span>
      `:''}
      <button class="b right" data-a="archive">Archivar</button>
    </div>
  </article>`;
}

/* suscripci√≥n */
let firstPaint = true;
onSnapshot(
  query(collection(db,'orders'), where('status','in',['PENDING','IN_PROGRESS','READY']), orderBy('createdAt','desc')),
  (snap)=>{
    const pend=[], prog=[], ready=[];
    snap.forEach(d=>{
      const o=d.data();
      if(o.status==='PENDING')    pend.push(card(d.id,o));
      if(o.status==='IN_PROGRESS') prog.push(card(d.id,o));
      if(o.status==='READY')       ready.push(card(d.id,o));
    });
    $p.innerHTML = pend.join('') || '<div class="meta">Sin pendientes</div>';
    $g.innerHTML = prog.join('') || '<div class="meta">Sin preparaci√≥n</div>';
    $r.innerHTML = ready.join('') || '<div class="meta">Sin listos</div>';

    // beep solo cuando entra un nuevo PENDING despu√©s del primer render
    if(!firstPaint && pend.length){ beep(); }
    firstPaint = false;
  }
);

/* acciones */
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-a]');
  if(!btn) return;
  const card = btn.closest('.card'); const id = card?.dataset.id; if(!id) return;
  const a = btn.dataset.a;
  if(a==='take'){
    await updateDoc(doc(db,'orders',id), { status:'IN_PROGRESS', startedAt: serverTimestamp() });
  }
  if(a==='ready'){
    await updateDoc(doc(db,'orders',id), { status:'READY', readyAt: serverTimestamp() });
  }
  if(a==='archive'){
    // mover a orders_archive y borrar
    const ref = doc(db,'orders',id); const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data();
      await setDoc(doc(db,'orders_archive',id), { ...data, status:'DELIVERED', deliveredAt: serverTimestamp() });
      await deleteDoc(ref);
    }
  }
});
</script>
</body>
</html>
