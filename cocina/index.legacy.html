<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Cocina — Seven (Legacy)</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <style>
    :root{ --bg:#0b1220; --card:#0f182a; --panel:#131f33; --muted:#a6b2c7; --chip:#192840; }
    body{ background:var(--bg); color:#e8f0ff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:12px auto; padding:0 12px; }
    .cols{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width:900px){ .cols{ grid-template-columns:1fr; } }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
    .ord{ background:var(--panel); border:1px solid rgba(255,255,255,.07); border-radius:10px; padding:10px; margin-bottom:8px; }
    .muted{ color:var(--muted); font-size:12px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .chip{ background:var(--chip); border:1px solid rgba(255,255,255,.10); border-radius:999px; padding:4px 8px; font-size:12px; white-space:nowrap; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .btn{ background:#1a2740; border:1px solid rgba(255,255,255,.12); color:#e8f0ff; border-radius:10px; padding:8px 10px; }
    .btn[disabled]{ opacity:.6; pointer-events:none; }
    .btn.ok{ background:#2fe38b; color:#00150a; font-weight:800; }
    a.track{ color:#8bb4ff; text-decoration:underline; font-size:12px; }
    .empty{ color:var(--muted); padding:10px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    h3{ margin:0 0 8px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="cols">
    <div class="card"><h3>Pendientes</h3><div id="col-pending"></div></div>
    <div class="card"><h3>En preparación</h3><div id="col-progress"></div></div>
    <div class="card"><h3>Listos</h3><div id="col-ready"></div></div>
    <div class="card"><h3>Por cobrar</h3><div id="col-bill"></div></div>
  </div>
</div>

<!-- Firebase v8 (máxima compatibilidad) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
(function(){
  // ========= Config =========
  var firebaseConfig = {
    apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
    authDomain: "seven-de-burgers.firebaseapp.com",
    databaseURL: "https://seven-de-burgers-default-rtdb.firebaseio.com",
    projectId: "seven-de-burgers",
    storageBucket: "seven-de-burgers.appspot.com",
    messagingSenderId: "34089845279",
    appId: "1:34089845279:web:d13440c34e6bb7fa910b2a"
  };
  firebase.initializeApp(firebaseConfig);
  var rtdb = firebase.database();
  var RTDB_PATH = "kitchen/orders";
  var ENDPOINT_STATUS = "https://us-central1-seven-de-burgers.cloudfunctions.net/kitchenSetStatus";
  var ENDPOINT_CHARGE = "https://us-central1-seven-de-burgers.cloudfunctions.net/kitchenCharge";
  var SECRET = "pon_el_mismo_secret_de_functions";

  // ========= Helpers =========
  var COLS = {
    PENDING:     document.getElementById('col-pending'),
    IN_PROGRESS: document.getElementById('col-progress'),
    READY:       document.getElementById('col-ready'),
    BILL:        document.getElementById('col-bill')
  };
  function money(n){ return '$'+Number(n||0).toFixed(0); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];}); }
  function buzz(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms||50); }catch(e){} }
  function calcTotal(o){
    if (typeof o.subtotal === 'number') return Number(o.subtotal||0) + Number(o.tip||0);
    var s=0, items = Array.isArray(o.items)?o.items:[];
    for (var i=0;i<items.length;i++){
      var it = items[i];
      var line = (typeof it.lineTotal==='number') ? Number(it.lineTotal||0) : (Number(it.unitPrice||0) * Number(it.qty||1));
      s += line;
    }
    return s + Number(o.tip||0);
  }
  function chip(txt){ return '<span class="chip">'+esc(txt)+'</span>'; }

  // === Normalizador de pagos (robusto) ===
  function isPaid(o){
    if (!o) return false;
    var raw = (o.paid != null ? o.paid : null);
    if (raw == null && o.payment && o.payment.paid != null) raw = o.payment.paid;
    if (raw == null && o.meta && o.meta.paid != null)       raw = o.meta.paid;
    if (raw == null && o.payStatus != null)                 raw = o.payStatus;
    if (raw === true || raw === 1) return true;
    if (typeof raw === 'string'){
      var s = raw.trim().toLowerCase();
      if (s === 'true' || s === '1' || s === 'paid' || s === 'pagado' || s === 'sí' || s === 'si' || s === 'yes') return true;
    }
    var st = String(o.status||'').toUpperCase();
    if (st === 'PAID') return true;
    if (o.paidAt || (o.payment && (o.payment.paidAt || o.payment.tx || o.payment.reference))) return true;
    return false;
  }

  // ========= Render =========
  function buildCard(o){
    var totalVal = calcTotal(o);
    var isDine = String(o.orderType||'').toLowerCase()==='dinein';
    var meta  = isDine ? ('Mesa '+(o.table||'?')) : (o.orderType||'pickup');
    var track = o.id ? '<a class="track" href="../track/?id='+encodeURIComponent(o.id)+'" target="_blank" rel="noopener">Ver en Track</a>' : '';

    var items = Array.isArray(o.items)?o.items:[];
    var lines = '';
    for (var i=0;i<items.length;i++){
      var it = items[i];
      var bi = Array.isArray(it.baseIngredients) ? it.baseIngredients : (Array.isArray(it.ingredients)?it.ingredients:[]);
      var sauces = (it.extras && Array.isArray(it.extras.sauces)) ? it.extras.sauces : [];
      var ingr   = (it.extras && Array.isArray(it.extras.ingredients)) ? it.extras.ingredients : [];
      var dlc    = (it.extras && it.extras.dlcCarne) ? ['DLC carne 85g'] : [];
      var salsa  = it.salsaCambiada ? ('Salsa: '+it.salsaCambiada+' (cambio)') : (it.salsaDefault ? ('Salsa: '+it.salsaDefault) : '');
      var chips  = [].concat(bi).concat(sauces.map(function(s){return 'Aderezo: '+s;})).concat(ingr.map(function(x){return 'Extra: '+x;})).concat(dlc);
      lines += ''
        + '<div class="muted">'+esc(it.qty||1)+'× '+esc(it.name||'Producto')+'</div>'
        + (salsa ? '<div class="muted">'+esc(salsa)+'</div>' : '')
        + '<div class="chips">'+chips.map(chip).join('')+'</div>'
        + (it.notes ? '<div class="muted">Notas: '+esc(it.notes)+'</div>' : '');
    }

    // Línea de totales: cambia el texto si está pagado
    var totalLine = isPaid(o)
      ? ('Total: <b>'+money(totalVal)+'</b> · <span class="chip">Pagado</span>')
      : ('Total por cobrar: <b>'+money(totalVal)+'</b>');

    var s = String(o.status||'PENDING').toUpperCase();
    var btns =
      (s==='PENDING')      ? '<button class="btn" data-a="IN_PROGRESS" data-id="'+esc(o.id)+'">Tomar</button>' :
      (s==='IN_PROGRESS')  ? '<button class="btn ok" data-a="READY" data-id="'+esc(o.id)+'">Listo</button>' :
      (s==='READY')        ? '<button class="btn" data-a="DELIVERED" data-id="'+esc(o.id)+'">Entregar</button>' :
      ((s==='DELIVERED' && !isPaid(o)) ? '<button class="btn ok" data-charge data-id="'+esc(o.id)+'">Cobrar</button>' : '');

    return ''
      + '<div class="ord">'
      +   '<div><b>'+esc(o.customer||'-')+'</b> · <span class="muted">'+esc(meta)+'</span> '+track+'</div>'
      +   '<div class="muted">'+totalLine+'</div>'
      +   (o.notes ? '<div class="muted"><b>Notas generales:</b> '+esc(o.notes)+'</div>' : '')
      +   lines
      +   '<div class="row" style="margin-top:6px">'+btns+'</div>'
      + '</div>';
  }

  function render(list){
    // 1) Filtro duro: fuera pagadas, $0, sin items, DONE/CANCELLED/PAID
    var cleaned = [];
    (list||[]).forEach(function(o){
      var s = String(o.status||'PENDING').toUpperCase();
      var total = calcTotal(o);
      var hasItems = Array.isArray(o.items) && o.items.length>0;
      if (isPaid(o)) return;
      if (total <= 0 || !hasItems) return;
      if (s==='DONE' || s==='CANCELLED' || s==='PAID') return;
      cleaned.push(o);
    });

    // 2) Agrupar
    var by = {PENDING:[], IN_PROGRESS:[], READY:[], BILL:[]};
    cleaned.forEach(function(o){
      var s = String(o.status||'PENDING').toUpperCase();
      if (s==='DELIVERED') by.BILL.push(o);
      else if (by[s]) by[s].push(o);
      else by.PENDING.push(o);
    });

    // 3) Pintar
    function setCol(el, arr){
      if (!el) return;
      el.innerHTML = arr.length ? arr.map(buildCard).join('') : '<div class="empty">—</div>';
    }
    setCol(COLS.PENDING, by.PENDING);
    setCol(COLS.IN_PROGRESS, by.IN_PROGRESS);
    setCol(COLS.READY, by.READY);
    setCol(COLS.BILL, by.BILL);

    // 4) Bind acciones
    var btns = document.querySelectorAll('[data-id][data-a]');
    for (var i=0;i<btns.length;i++){
      (function(b){ b.onclick = function(){ doAction(b.getAttribute('data-id'), b.getAttribute('data-a'), b); }; })(btns[i]);
    }
    var chs = document.querySelectorAll('[data-id][data-charge]');
    for (var j=0;j<chs.length;j++){
      (function(b){ b.onclick = function(){ doCharge(b.getAttribute('data-id'), b); }; })(chs[j]);
    }
  }

  // ========= Estado / fuentes =========
  var prevIds = {};
  var lastRenderAt = 0;
  var lastNonEmptyAt = 0;

  function toList(val){
    var obj = val || {};
    var keys = Object.keys(obj);
    var arr = [];
    for (var i=0;i<keys.length;i++){
      var id = keys[i];
      var o  = obj[id] || {};
      if (!o.id) o.id = id;
      arr.push(o);
    }
    // ordenar por createdAt
    arr.sort(function(a,b){
      var ta = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds*1000 : Number(a.createdAt||0);
      var tb = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds*1000 : Number(b.createdAt||0);
      return ta - tb;
    });
    return arr;
  }

  function onSnapshot(val){
    var list = toList(val);
    render(list);
    lastRenderAt = Date.now();
    if (list.length>0) lastNonEmptyAt = lastRenderAt;

    // vibrar si aparecieron nuevos
    var idsNow = {};
    for (var i=0;i<list.length;i++) idsNow[String(list[i].id||'')] = 1;
    var newCount = 0;
    for (var k in idsNow){ if (!prevIds[k]) newCount++; }
    if (newCount>0) buzz(60);
    prevIds = idsNow;
  }

  // RTDB live
  try{
    rtdb.ref(RTDB_PATH).on('value', function(snap){
      var data = snap.val();
      onSnapshot(data || {});
    });
  }catch(e){/* sigue con polling */ }

  // Polling (fallback)
  var ENDPOINT = firebaseConfig.databaseURL.replace(/\/$/,'') + '/' + RTDB_PATH + '.json';
  var pollFast = false;
  function tick(){
    try{
      var xhr = new XMLHttpRequest();
      xhr.open('GET', ENDPOINT + '?t=' + Date.now(), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4 && xhr.status === 200){
          try{
            var data = JSON.parse(xhr.responseText||'{}') || {};
            if ((Date.now()-lastRenderAt) > 1200) onSnapshot(data);
          }catch(e){}
        }
      };
      xhr.send(null);
    }catch(e){}
  }
  setInterval(function(){ tick(); }, function(){ return pollFast ? 2000 : 5000; }());

  // Watchdog: acelera si RTDB no entrega
  setInterval(function(){
    var now = Date.now();
    pollFast = ((now - lastRenderAt) > 6000 || (now - lastNonEmptyAt) > 10000);
  }, 1500);

  // ========= Acciones (Cloud Functions) =========
  var busyByOrder = {}; // id -> ts
  function lock(btn, id){ if (btn){ btn.disabled = true; btn.setAttribute('aria-busy','true'); } busyByOrder[id] = Date.now(); }
  function unlock(btn, id){ if (btn){ btn.disabled = false; btn.removeAttribute('aria-busy'); } delete busyByOrder[id]; }

  function doAction(id, action, btn){
    if (!id || !action || busyByOrder[id]) return;
    lock(btn, id);
    fetch(ENDPOINT_STATUS, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ id:id, action:action, secret:SECRET })
    }).then(function(r){ return r.json(); })
      .then(function(j){ if (!j.ok) alert('Error: '+(j.error||'')); else buzz(30); })
      .catch(function(){ alert('Error de red'); })
      .finally(function(){ unlock(btn, id); });
  }

  function doCharge(id, btn){
    if (!id || busyByOrder[id]) return;
    var method = prompt('Método (efectivo / tarjeta / transferencia):','efectivo');
    if (method===null) return;
    lock(btn, id);
    fetch(ENDPOINT_CHARGE, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ id:id, method:method, secret:SECRET })
    }).then(function(r){ return r.json(); })
      .then(function(j){ if (!j.ok) alert('Error: '+(j.error||'')); else buzz(40); })
      .catch(function(){ alert('Error de red'); })
      .finally(function(){ unlock(btn, id); });
  }
})();
</script>
</body>
</html>
