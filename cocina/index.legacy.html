<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cocina — Seven (Legacy)</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <style>
    body{ background:#0b1220; color:#e8f0ff; font-family: system-ui, Arial; }
    .wrap{ max-width:1200px; margin:12px auto; padding:0 12px; }
    .cols{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width:900px){ .cols{ grid-template-columns:1fr; } }
    .card{ background:#0f182a; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
    .ord{ background:#131f33; border:1px solid rgba(255,255,255,.07); border-radius:10px; padding:10px; margin-bottom:8px; }
    .muted{ color:#a6b2c7; font-size:12px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .chip{ background:#192840; border:1px solid rgba(255,255,255,.10); border-radius:999px; padding:4px 8px; font-size:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .btn{ background:#1a2740; border:1px solid rgba(255,255,255,.12); color:#e8f0ff; border-radius:10px; padding:8px 10px; }
    .btn.ok{ background:#2fe38b; color:#00150a; font-weight:800; }
    a.track{ color:#8bb4ff; text-decoration:underline; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="cols">
    <div class="card"><h3>Pendientes</h3><div id="col-pending"></div></div>
    <div class="card"><h3>En preparación</h3><div id="col-progress"></div></div>
    <div class="card"><h3>Listos</h3><div id="col-ready"></div></div>
    <div class="card"><h3>Por cobrar</h3><div id="col-bill"></div></div>
  </div>
</div>

<!-- Firebase v8 para máxima compatibilidad -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  /* =================== Config / Constantes =================== */
  const firebaseConfig = {
    apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
    authDomain: "seven-de-burgers.firebaseapp.com",
    databaseURL: "https://seven-de-burgers-default-rtdb.firebaseio.com",
    projectId: "seven-de-burgers",
    storageBucket: "seven-de-burgers.appspot.com",
    messagingSenderId: "34089845279",
    appId: "1:34089845279:web:d13440c34e6bb7fa910b2a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const ENDPOINT_STATUS = "https://us-central1-seven-de-burgers.cloudfunctions.net/kitchenSetStatus";
  const ENDPOINT_CHARGE = "https://us-central1-seven-de-burgers.cloudfunctions.net/kitchenCharge";
  const SECRET = "pon_el_mismo_secret_de_functions";

  const COLS = {
    PENDING:     document.getElementById('col-pending'),
    IN_PROGRESS: document.getElementById('col-progress'),
    READY:       document.getElementById('col-ready'),
    BILL:        document.getElementById('col-bill'),
  };

  /* =================== Utils UI =================== */
  const money = (n)=> '$'+Number(n||0).toFixed(0);
  const esc   = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const chip  = (txt)=> '<span class="chip">'+esc(txt)+'</span>';

  function calcTotal(o){
    // si viene subtotal ya calculado desde kiosko, úsalo (incluye HH y extras)
    if (typeof o.subtotal === 'number') return Number(o.subtotal||0) + Number(o.tip||0);
    const items = Array.isArray(o.items) ? o.items : [];
    let s=0;
    for (let i=0;i<items.length;i++){
      const it=items[i];
      const line = (typeof it.lineTotal==='number')
        ? Number(it.lineTotal||0)
        : (Number(it.unitPrice||0) * Number(it.qty||1));
      s += line;
    }
    return s + Number(o.tip||0);
  }

  function sortByCreatedAtAsc(a,b){
    // En RTDB guardamos createdAt como número (Date.now()) desde el mirror
    const ta = Number(a.createdAt || 0);
    const tb = Number(b.createdAt || 0);
    return ta - tb;
  }

  /* =================== Render =================== */
  function render(list){
    const by = {PENDING:[], IN_PROGRESS:[], READY:[], BILL:[]};
    (list||[]).forEach(o=>{
      const s = String(o.status||'PENDING').toUpperCase();
      if (s==='DELIVERED' && !o.paid) by.BILL.push(o);
      else if (by[s]) by[s].push(o);
      else by.PENDING.push(o);
    });

    for (const k in by){
      const cont = k==='BILL' ? COLS.BILL : COLS[k];
      if (!cont) continue;
      cont.innerHTML = by[k].map(renderCard).join('');
    }

    // bind acciones
    document.querySelectorAll('[data-id][data-a]').forEach(btn=>{
      btn.onclick = () => doAction(btn.getAttribute('data-id'), btn.getAttribute('data-a'));
    });
    document.querySelectorAll('[data-id][data-charge]').forEach(btn=>{
      btn.onclick = () => doCharge(btn.getAttribute('data-id'));
    });
  }

  function renderCard(o){
    const total = money(calcTotal(o));
    const meta  = o.orderType==='dinein' ? ('Mesa '+(o.table||'?')) : (o.orderType||'pickup');

    const items = Array.isArray(o.items) ? o.items : [];
    let lines = '';
    for (let i=0;i<items.length;i++){
      const it = items[i];

      // ingredientes base (lo que antes "desaparecía")
      const base = Array.isArray(it.baseIngredients) ? it.baseIngredients
                 : Array.isArray(it.ingredients) ? it.ingredients : [];

      const ex = it.extras || {};
      const sauces = Array.isArray(ex.sauces) ? ex.sauces : [];
      const ingr   = Array.isArray(ex.ingredients) ? ex.ingredients : [];
      const dlc    = ex.dlcCarne ? ['DLC carne 85g'] : [];

      const chips = []
        .concat(base)                                // <= ahora siempre incluidos
        .concat(sauces.map(s => 'Aderezo: ' + s))
        .concat(ingr.map(x => 'Extra: ' + x))
        .concat(dlc);

      const salsaTxt = it.salsaCambiada
        ? ('Salsa: ' + it.salsaCambiada)
        : (it.salsaDefault ? ('Salsa: ' + it.salsaDefault) : '');

      lines += `
        <div class="muted">${(it.qty||1)}× ${esc(it.name||'Producto')}</div>
        ${salsaTxt ? `<div class="muted">${esc(salsaTxt)}</div>` : ``}
        <div class="chips">${chips.map(chip).join('')}</div>
        ${it.notes ? `<div class="muted">Notas: ${esc(it.notes)}</div>` : ``}
      `;
    }

    const s = String(o.status||'PENDING').toUpperCase();
    const btns =
      (s==='PENDING')      ? `<button class="btn" data-a="IN_PROGRESS" data-id="${esc(o.id)}">Tomar</button>` :
      (s==='IN_PROGRESS')  ? `<button class="btn ok" data-a="READY" data-id="${esc(o.id)}">Listo</button>` :
      (s==='READY')        ? `<button class="btn" data-a="DELIVERED" data-id="${esc(o.id)}">Entregar</button>` :
      (s==='DELIVERED' && !o.paid) ? `<button class="btn ok" data-charge data-id="${esc(o.id)}">Cobrar</button>` : ``;

    // “Ver en Track”: usamos OID si lo tenemos
    const trackHref = `../track/track.html?oid=${encodeURIComponent(o.id||'')}`;

    return `
      <div class="ord">
        <div><b>${esc(o.customer||'-')}</b> · <span class="muted">${esc(meta)}</span> · <a class="track" href="${trackHref}" target="_blank" rel="noopener">Ver en Track</a></div>
        <div class="muted">Total: <b>${total}</b> ${o.paid ? '· <span class="chip">Pagado</span>' : ''}</div>
        ${o.notes ? `<div class="muted"><b>Notas generales:</b> ${esc(o.notes)}</div>` : ``}
        ${lines}
        <div class="row" style="margin-top:6px">${btns}</div>
      </div>
    `;
  }

  /* =================== Acciones =================== */
  function doAction(id, action){
    fetch(ENDPOINT_STATUS, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ id, action, secret: SECRET })
    })
    .then(r=>r.json())
    .then(j=>{ if (!j.ok) alert('Error: '+(j.error||'')); })
    .catch(()=> alert('Error de red'));
  }

  function doCharge(id){
    const method = prompt('Método (efectivo / tarjeta / transferencia):','efectivo');
    if (method===null) return;
    fetch(ENDPOINT_CHARGE, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ id, method, secret: SECRET })
    })
    .then(r=>r.json())
    .then(j=>{ if (!j.ok) alert('Error: '+(j.error||'')); })
    .catch(()=> alert('Error de red'));
  }

  /* =================== Datos: Live + Fallback =================== */
  let lastLiveAt = 0;
  let unsubscribed = false;

  // Suscripción en vivo (preferida)
  try{
    db.ref('kitchen/orders').on('value', snap=>{
      const raw = snap.val() || {};
      const list = Object.keys(raw).map(id => ({ id, ...raw[id] }));
      list.sort(sortByCreatedAtAsc);
      render(list);
      lastLiveAt = Date.now();
    });
  }catch(e){ /* si falla, el fallback se hará cargo */ }

  // Fallback por XHR SOLO si no hay live por 5s (o se pierde)
  const ENDPOINT_JSON = firebaseConfig.databaseURL + "/kitchen/orders.json";
  function fallbackTick(){
    const stale = Date.now() - lastLiveAt > 5000; // 5s sin evento en vivo
    if (!stale || document.hidden) return;
    try{
      const xhr = new XMLHttpRequest();
      xhr.open('GET', ENDPOINT_JSON + '?t=' + Date.now(), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4 && xhr.status === 200){
          const data = JSON.parse(xhr.responseText || '{}') || {};
          const list = Object.keys(data).map(id => ({ id, ...data[id] }));
          list.sort(sortByCreatedAtAsc);
          render(list);
        }
      };
      xhr.send(null);
    }catch(e){}
  }
  setInterval(fallbackTick, 2000);
  document.addEventListener('visibilitychange', fallbackTick, false);
</script>
</body>
</html>
