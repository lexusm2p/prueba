<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0b1220">
<title>Seven Stickers S1 · Viewer</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --card:#131c2e; --muted:#8aa0c2; --text:#e8f0ff;
    --accent:#ffd166; --accent-2:#7dd3fc; --success:#34d399; --danger:#f87171;
    --chip:#1b2946; --chip-b:#243454; --border:rgba(255,255,255,.08);
    --gold:#FBBF24; --rare:#60A5FA; --epic:#A78BFA; --common:#6EE7B7;
  }
  *{box-sizing:border-box}
  html,body{width:100%;max-width:100%;overflow-x:hidden}
  body{
    margin:0; background: radial-gradient(1200px 600px at 10% -10%, #14203c 0%, #0b1220 50%, #0b1220 100%);
    color:var(--text); font: 14px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    -webkit-text-size-adjust:100%;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg, rgba(19,28,46,.98) 0%, rgba(19,28,46,.88) 100%);
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:clamp(10px,2.8vw,16px);}
  h1{margin:0 0 6px; font-weight:800; letter-spacing:.3px;}
  .muted{color:var(--muted)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .sp{flex:1}
  select,input[type="search"]{
    background:#0f182a; border:1px solid var(--border); color:var(--text);
    padding:10px 12px; border-radius:10px; min-width:120px;
  }
  input[type="search"]{ width:210px }
  button{
    border:1px solid var(--border); color:var(--text); background:#0f182a;
    padding:10px 12px; border-radius:10px; cursor:pointer;
  }
  button.primary{ background: var(--accent); color:#1a1200; border-color:#d1a81f; font-weight:700}
  button.ghost{background:#0f182a}
  button:disabled{opacity:.5; cursor:not-allowed}
  .chips{display:flex; gap:8px; flex-wrap:nowrap; overflow:auto; padding-bottom:4px; -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity}
  .chips::-webkit-scrollbar{height:6px}
  .chip{background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none; white-space:nowrap; scroll-snap-align:start}
  .chip.active{background:var(--chip-b)}
  /* grid */
  .grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
    margin:16px auto 40px;
  }
  @media (max-width: 420px){
    .grid{ grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
  }
  .card{
    background:linear-gradient(180deg,#0f182a 0%,#0b1424 100%); border:1px solid var(--border);
    border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:10px;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .card:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.25) }
  .media{
    aspect-ratio:1/1; border-radius:12px; overflow:hidden; background:#0a1120; display:grid; place-items:center;
    border:1px solid var(--border); position:relative;
    max-width:100%;
  }
  .media img{ width:100%; height:100%; object-fit:contain; image-rendering:pixelated }
  .placeholder{
    width:100%; height:100%; display:grid; place-items:center; color:#fff; font-weight:700; padding:8px; text-align:center;
    background: repeating-linear-gradient(45deg, #162546, #162546 10px, #0f1b36 10px, #0f1b36 20px);
  }
  .title{font-weight:800}
  .rar{font-weight:700; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid transparent}
  /* color-mix con fallback */
  .rar.common{ color:var(--common); background:#0d1f1a; border-color:#134733; }
  .rar.rare{   color:var(--rare);   background:#0c1629; border-color:#1c3e7a; }
  .rar.epic{   color:var(--epic);   background:#140f25; border-color:#3f2f78; }
  .rar.gold{   color:var(--gold);   background:#201703; border-color:#6b530c; }
  @supports (background: color-mix(in oklab, white 10%, black)) {
    .rar.common{background:color-mix(in oklab,var(--common) 22%, black); border-color:color-mix(in oklab,var(--common) 45%, black)}
    .rar.rare{  background:color-mix(in oklab,var(--rare) 22%, black); border-color:color-mix(in oklab,var(--rare) 45%, black)}
    .rar.epic{  background:color-mix(in oklab,var(--epic) 22%, black); border-color:color-mix(in oklab,var(--epic) 45%, black)}
    .rar.gold{  background:color-mix(in oklab,var(--gold) 22%, black); border-color:color-mix(in oklab,var(--gold) 45%, black)}
  }
  .progress{height:10px;background:#0e172a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--success),#a7f3d0)}
  /* modal */
  dialog{
    border:1px solid var(--border); background:linear-gradient(180deg,#0f182a,#0b1424); color:var(--text);
    border-radius:16px; width:min(960px,calc(100% - 24px));
  }
  dialog::backdrop{background:rgba(0,0,0,.5); backdrop-filter: blur(2px)}
  .d-body{display:grid; gap:14px; grid-template-columns: 340px 1fr; padding:12px}
  .foil{
    position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.75;
    background:
      radial-gradient(120px 80px at 10% 10%, rgba(255,255,255,.35), transparent 60%),
      conic-gradient(from var(--a,0deg), #fff0 0%, rgba(255,241,175,.35) 10%, #fff0 20%, rgba(173,216,230,.25) 35%, #fff0 55%, rgba(255,201,125,.35) 70%, #fff0 100%);
    animation: foil 4s linear infinite;
  }
  @media (prefers-reduced-motion: reduce){ .foil{ animation:none } }
  @keyframes foil{ to{ --a: 360deg; } }
  .footer{position:sticky; bottom:0; padding:10px 0; background:linear-gradient(180deg,transparent,rgba(0,0,0,.25))}
  .tiny{font-size:12px}
  .badge{font-weight:700; font-size:12px; padding:4px 10px; border-radius:999px; background:#13203a; border:1px solid var(--border); color:var(--muted)}
  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:50;
    background:#0f182a; border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:none; max-width:min(92vw,520px);
    box-shadow:0 10px 24px rgba(0,0,0,.3);
  }
  .toast.show{ display:block; animation:pop .18s ease-out }
  @keyframes pop{ from{ transform:translate(-50%,8px); opacity:.3 } to{ transform:translate(-50%,0); opacity:1 } }

  /* ======================= RESPONSIVE ======================= */
  /* Fila superior: titulo + filtros en columnas cuando no cabe */
  @media (max-width: 820px){
    header .row:first-child{ align-items:flex-start }
    header .row[role="group"]{ width:100%; display:grid; grid-template-columns:1fr 1fr; gap:8px }
    header select, header input[type="search"], header button{ width:100% }
    #btnReset{ order:3 }
    #btnOpen{ order:4 }
    input[type="search"]{ width:100% }
  }
  @media (max-width: 480px){
    header .row[role="group"]{ grid-template-columns:1fr; }
    .badge{ font-size:11px; }
  }

  /* Chips a una línea con scroll ya definido (arriba) */

  /* Modal a una columna en móvil */
  @media (max-width: 720px){
    .d-body{ grid-template-columns: 1fr; }
    #dlgMedia .media{ max-width:min(92vw,420px); margin:0 auto; }
  }

  /* Footer: botones se apilan en móvil */
  @media (max-width: 540px){
    .footer.row{ flex-direction:column; align-items:stretch; gap:8px }
    .footer .sp{ display:none }
    .footer button{ width:100% }
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Seven Stickers S1</h1>
        <div class="muted tiny">Viewer · sobres, álbum y progreso</div>
      </div>
      <div class="sp"></div>
      <div class="row" role="group" aria-label="Filtros">
        <select id="fPage" aria-label="Página del álbum"></select>
        <select id="fRarity" aria-label="Rareza">
          <option value="">Todas las rarezas</option>
        </select>
        <input id="fSearch" type="search" placeholder="Buscar personaje…" aria-label="Buscar personaje"/>
        <button class="ghost" id="btnReset" title="Limpiar filtros">Reset</button>
        <button class="primary" id="btnOpen">Abrir sobre</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="badge" id="albumProgress" aria-live="polite">Álbum 0/0</div>
      <div class="badge" id="goldCount" aria-live="polite">Dorados 0</div>
      <div class="sp"></div>
      <div class="chips" id="pageChips" role="group" aria-label="Páginas del álbum"></div>
    </div>
  </div>
</header>

<main class="wrap">
  <div style="margin:12px 0">
    <div class="progress" aria-label="Progreso del álbum" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="bar" style="width:0%"></i></div>
  </div>

  <section id="grid" class="grid" aria-live="polite"></section>

  <div class="footer row">
    <div class="muted tiny">Tip: tus coleccionables se guardan en este dispositivo.</div>
    <div class="sp"></div>
    <button id="btnExport">Exportar colección</button>
    <button id="btnImport">Importar</button>
    <button class="ghost" id="btnClear">Borrar colección</button>
  </div>
</main>

<dialog id="dlg">
  <div class="d-body">
    <div class="media" id="dlgMedia">
      <div class="placeholder">Imagen</div>
    </div>
    <div>
      <div class="row">
        <h2 id="dlgTitle" style="margin:0; font-weight:800"></h2>
        <span id="dlgRarity" class="rar" aria-label="Rareza"></span>
      </div>
      <div class="muted" id="dlgLore"></div>
      <div class="row" style="margin:8px 0">
        <span class="badge" id="dlgPages" title="Páginas"></span>
        <span class="badge" id="dlgTags" title="Etiquetas"></span>
      </div>

      <div class="row" style="gap:10px; margin-top:4px">
        <button id="btnMarkOwned" class="primary">Tengo 1</button>
        <button id="btnRemoveOwned" class="ghost">Quitar 1</button>
        <span class="muted">Cantidad: <b id="dlgOwned">0</b></span>
      </div>
    </div>
  </div>
  <form method="dialog" style="padding:0 12px 12px">
    <button aria-label="Cerrar">✕ Cerrar</button>
  </form>
</dialog>

<div id="toast" class="toast"></div>

<script>
/* ====== Datos del set (los tuyos tal cual) ====== */
const DATA = {
  "setName": "Seven Stickers S1",
  "rarities": [
    {"id":"common","label":"Común","color":"#6EE7B7","packOdds":65},
    {"id":"rare","label":"Raro","color":"#60A5FA","packOdds":25},
    {"id":"epic","label":"Épico","color":"#A78BFA","packOdds":9},
    {"id":"gold","label":"Dorado","color":"#FBBF24","packOdds":1,"foil":true}
  ],
  "pack": {"size":5,"bonusOnExtra":true,"bonusNote":"+1 si el pedido lleva extras"},
  "album": [
    {"pageId":"minis","title":"Liga Mini"},
    {"pageId":"fire","title":"Fuego & Picante"},
    {"pageId":"boss","title":"Jefe Final"},
    {"pageId":"tech","title":"Tecno-Neón"},
    {"pageId":"ninja","title":"Ninja Dojo"},
    {"pageId":"classic","title":"Clásicos"},
    {"pageId":"mx","title":"Fiesta MX"}
  ],
  "rewards": [
    {"trigger":"complete_page:minis","reward":"aderezo_sorpresa"},
    {"trigger":"complete_set:season1","reward":"upgrade_carne_85g"},
    {"trigger":"achievement:combo_3_minis","reward":"cupón_hh_base"},
    {"trigger":"collect:gold_5","reward":"fastlane_qr_support"}
  ],
  "characters": [
    {"id":"starter-mini","name":"Starter Mini","lore":"Pequeña, poderosa y siempre lista para la aventura.","palette":["#F59E0B","#22C55E","#EF4444","#0EA5E9"],"tags":["mini","clásico"],"poses":["idle","blink","wave"],"pages":["minis","classic"],"variants":[{"rarity":"common","file":"seven_starter-mini_common.png"},{"rarity":"rare","file":"seven_starter-mini_rare.png"},{"rarity":"epic","file":"seven_starter-mini_epic.png"},{"rarity":"gold","file":"seven_starter-mini_gold.png","foil":true,"shineFrames":8}]},
    {"id":"dread-lord","name":"Dread Lord","lore":"El sabor más audaz del menú. ¿Te atreves a enfrentarlo?","palette":["#4B5563","#EF4444","#1F2937","#9CA3AF"],"tags":["jefe","fuego","oscuro"],"poses":["idle","roar","smirk"],"pages":["boss","fire"],"variants":[{"rarity":"common","file":"seven_dread-lord_common.png"},{"rarity":"rare","file":"seven_dread-lord_rare.png"},{"rarity":"epic","file":"seven_dread-lord_epic.png"},{"rarity":"gold","file":"seven_dread-lord_gold.png","foil":true,"shineFrames":8}]},
    {"id":"sparky","name":"Sparky","lore":"Una pequeña explosión de sabor y felicidad.","palette":["#FBBF24","#FCD34D","#9CA3AF","#EF4444"],"tags":["mini","cute","electric"],"poses":["idle","happy","giggle"],"pages":["minis"],"variants":[{"rarity":"common","file":"seven_sparky_common.png"},{"rarity":"rare","file":"seven_sparky_rare.png"},{"rarity":"epic","file":"seven_sparky_epic.png"},{"rarity":"gold","file":"seven_sparky_gold.png","foil":true,"shineFrames":8}]},
    {"id":"sage-blaze","name":"Sage Blaze","lore":"La mente maestra detrás del fuego perfecto.","palette":["#3B82F6","#F97316","#1C1917","#9CA3AF"],"tags":["fuego","sabio","tecnología"],"poses":["idle","ponder","focus"],"pages":["fire","tech"],"variants":[{"rarity":"common","file":"seven_sage-blaze_common.png"},{"rarity":"rare","file":"seven_sage-blaze_rare.png"},{"rarity":"epic","file":"seven_sage-blaze_epic.png"},{"rarity":"gold","file":"seven_sage-blaze_gold.png","foil":true,"shineFrames":8}]},
    {"id":"spicy-shell","name":"Spicy Shell","lore":"No lo subestimes, su temperamento es tan ardiente como su sabor.","palette":["#10B981","#F97316","#DC2626","#FDBA74"],"tags":["picante","fuego"],"poses":["idle","growl","huff"],"pages":["fire","boss"],"variants":[{"rarity":"common","file":"seven_spicy-shell_common.png"},{"rarity":"rare","file":"seven_spicy-shell_rare.png"},{"rarity":"epic","file":"seven_spicy-shell_epic.png"},{"rarity":"gold","file":"seven_spicy-shell_gold.png","foil":true,"shineFrames":8}]},
    {"id":"ninja-bun","name":"Ninja Bun","lore":"Maestro del sigilo y del ataque sorpresa.","palette":["#EF4444","#1F2937","#9CA3AF","#FBBF24"],"tags":["ninja","sigilo"],"poses":["idle","dash","hide"],"pages":["ninja"],"variants":[{"rarity":"common","file":"seven_ninja-bun_common.png"},{"rarity":"rare","file":"seven_ninja-bun_rare.png"},{"rarity":"epic","file":"seven_ninja-bun_epic.png"},{"rarity":"gold","file":"seven_ninja-bun_gold.png","foil":true,"shineFrames":8}]},
    {"id":"neon-chip","name":"Neo-Chip","lore":"El futuro del fast food, directo a tu paladar.","palette":["#06B6D4","#1F2937","#6EE7B7","#9CA3AF"],"tags":["tecno","neón","futuro"],"poses":["idle","scan","upload"],"pages":["tech"],"variants":[{"rarity":"common","file":"seven_neon-chip_common.png"},{"rarity":"rare","file":"seven_neon-chip_rare.png"},{"rarity":"epic","file":"seven_neon-chip_epic.png"},{"rarity":"gold","file":"seven_neon-chip_gold.png","foil":true,"shineFrames":8}]},
    {"id":"sauce-boss","name":"Sauce Boss","lore":"Su secreto está en la salsa... ¡y es irresistible!","palette":["#FCD34D","#FFFFFF","#DC2626","#9CA3AF"],"tags":["aderezo","chef","clásico"],"poses":["idle","pour","wink"],"pages":["classic"],"variants":[{"rarity":"common","file":"seven_sauce-boss_common.png"},{"rarity":"rare","file":"seven_sauce-boss_rare.png"},{"rarity":"epic","file":"seven_sauce-boss_epic.png"},{"rarity":"gold","file":"seven_sauce-boss_gold.png","foil":true,"shineFrames":8}]},
    {"id":"chilli-chomp","name":"Chilli Chomp","lore":"Un bocado de fuego que te dejará pidiendo más.","palette":["#F97316","#22C55E","#DC2626","#9CA3AF"],"tags":["picante","fuego"],"poses":["idle","choke","gasp"],"pages":["fire","mx"],"variants":[{"rarity":"common","file":"seven_chilli-chomp_common.png"},{"rarity":"rare","file":"seven_chilli-chomp_rare.png"},{"rarity":"epic","file":"seven_chilli-chomp_epic.png"},{"rarity":"gold","file":"seven_chilli-chomp_gold.png","foil":true,"shineFrames":8}]},
    {"id":"golden-patty","name":"Golden Patty","lore":"El sabor que todos buscan, el tesoro que pocos encuentran.","palette":["#FBBF24","#FCD34D","#9CA3AF","#1F2937"],"tags":["legendario","especial","raro"],"poses":["idle","sparkle","boast"],"pages":["boss","classic"],"variants":[{"rarity":"rare","file":"seven_golden-patty_rare.png"},{"rarity":"epic","file":"seven_golden-patty_epic.png"},{"rarity":"gold","file":"seven_golden-patty_gold.png","foil":true,"shineFrames":8}]},
    {"id":"mexi-bun","name":"Mexi Bun","lore":"¡El sabor de México en cada mordisco!","palette":["#FBBF24","#DC2626","#22C55E","#FCD34D"],"tags":["mexico","fiesta","festivo"],"poses":["idle","dance","fiesta"],"pages":["mx"],"variants":[{"rarity":"common","file":"seven_mexi-bun_common.png"},{"rarity":"rare","file":"seven_mexi-bun_rare.png"},{"rarity":"epic","file":"seven_mexi-bun_epic.png"},{"rarity":"gold","file":"seven_mexi-bun_gold.png","foil":true,"shineFrames":8}]},
    {"id":"mega-stack","name":"Mega Stack","lore":"El tamaño sí importa, especialmente cuando el hambre aprieta.","palette":["#F59E0B","#FBBF24","#EF4444","#1F2937"],"tags":["grande","jefe"],"poses":["idle","stretch","munch"],"pages":["boss","classic"],"variants":[{"rarity":"rare","file":"seven_mega-stack_rare.png"},{"rarity":"epic","file":"seven_mega-stack_epic.png"},{"rarity":"gold","file":"seven_mega-stack_gold.png","foil":true,"shineFrames":8}]},
    {"id":"glitch-burger","name":"Glitch Burger","lore":"Un error en la matriz que sabe increíblemente bien.","palette":["#8B5CF6","#EC4899","#2DD4BF","#1F2937"],"tags":["tecno","misterio"],"poses":["idle","teleport","static"],"pages":["tech"],"variants":[{"rarity":"rare","file":"seven_glitch-burger_rare.png"},{"rarity":"epic","file":"seven_glitch-burger_epic.png"},{"rarity":"gold","file":"seven_glitch-burger_gold.png","foil":true,"shineFrames":8}]},
    {"id":"pixel-pal","name":"Pixel Pal","lore":"Tu compañero fiel en cada aventura de sabor.","palette":["#F59E0B","#6B7280","#EF4444","#0EA5E9"],"tags":["clásico","gamer"],"poses":["idle","thumbs-up","game-on"],"pages":["classic","tech"],"variants":[{"rarity":"common","file":"seven_pixel-pal_common.png"},{"rarity":"rare","file":"seven_pixel-pal_rare.png"},{"rarity":"epic","file":"seven_pixel-pal_epic.png"},{"rarity":"gold","file":"seven_pixel-pal_gold.png","foil":true,"shineFrames":8}]},
    {"id":"mystery-bun","name":"Mystery Bun","lore":"¿Qué sabor se esconde detrás de esta máscara?","palette":["#374151","#F59E0B","#FBBF24","#22C55E"],"tags":["misterio","ninja"],"poses":["idle","peek","shrug"],"pages":["ninja","boss"],"variants":[{"rarity":"rare","file":"seven_mystery-bun_rare.png"},{"rarity":"epic","file":"seven_mystery-bun_epic.png"},{"rarity":"gold","file":"seven_mystery-bun_gold.png","foil":true,"shineFrames":8}]},
    {"id":"party-burger","name":"Party Burger","lore":"¡Cada bocado es una celebración!","palette":["#EC4899","#6EE7B7","#FBBF24","#EF4444"],"tags":["fiesta","festivo","alegre"],"poses":["idle","dance","cheer"],"pages":["mx","classic"],"variants":[{"rarity":"common","file":"seven_party-burger_common.png"},{"rarity":"rare","file":"seven_party-burger_rare.png"},{"rarity":"epic","file":"seven_party-burger_epic.png"},{"rarity":"gold","file":"seven_party-burger_gold.png","foil":true,"shineFrames":8}]}
  ]
};

/* ====== Estado y helpers ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const storeKey = 'seven:coll:v1';
let collection = safeParse(localStorage.getItem(storeKey)) || {};
const rarityMap = new Map(DATA.rarities.map(r=>[r.id,r]));
const allCards = buildCardList(DATA.characters);
let filters = restoreFilters();

function safeParse(s){ try{ return JSON.parse(s||''); }catch{ return null; } }

function buildCardList(chars){
  const list=[];
  for(const ch of chars){
    for(const v of ch.variants){
      list.push({
        key: `${ch.id}__${v.rarity}`,
        id: ch.id, name: ch.name, pages: ch.pages||[], tags: ch.tags||[],
        rarity: v.rarity, file: v.file, foil: !!v.foil, lore: ch.lore||'',
      });
    }
  }
  return list;
}
function own(key){ return Number(collection[key]||0); }
function setOwn(key,val){
  if(val<=0) delete collection[key]; else collection[key]=val;
  localStorage.setItem(storeKey, JSON.stringify(collection));
}

/* ====== UI ====== */
function initFilters(){
  const fPage = $('#fPage');
  fPage.innerHTML = `<option value="">Todas las páginas</option>` +
    DATA.album.map(a=>`<option value="${a.pageId}">${a.title}</option>`).join('');
  const chips = DATA.album.map(a=> `<button type="button" class="chip" data-page="${a.pageId}" aria-pressed="false">${a.title}</button>`).join('');
  $('#pageChips').innerHTML = chips;

  const fR = $('#fRarity');
  for(const r of DATA.rarities){
    const opt = document.createElement('option');
    opt.value = r.id; opt.textContent = r.label;
    fR.appendChild(opt);
  }

  // restaurar valores
  fPage.value = filters.page || '';
  fR.value = filters.rarity || '';
  $('#fSearch').value = filters.q || '';
  if(filters.page){
    const chip = $(`#pageChips .chip[data-page="${filters.page}"]`);
    chip?.classList.add('active'); chip?.setAttribute('aria-pressed','true');
  }

  fPage.onchange = ()=>{ filters.page = fPage.value; syncChipToSelect(); persistFilters(); renderGrid(); };
  fR.onchange = ()=>{ filters.rarity = fR.value; persistFilters(); renderGrid(); };

  const debounced = debounce((v)=>{ filters.q = v.toLowerCase().trim(); persistFilters(); renderGrid(); }, 120);
  $('#fSearch').addEventListener('input', e=> debounced(e.target.value));

  $('#btnReset').onclick = ()=>{
    filters={page:'',rarity:'',q:''};
    fPage.value=''; fR.value=''; $('#fSearch').value='';
    $$('#pageChips .chip').forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
    persistFilters();
    renderGrid();
  };

  $$('#pageChips .chip').forEach(ch=>{
    ch.onclick = ()=>{
      const p = ch.dataset.page;
      if(filters.page===p){
        filters.page=''; ch.classList.remove('active'); ch.setAttribute('aria-pressed','false'); $('#fPage').value='';
      } else {
        filters.page=p;
        $$('#pageChips .chip').forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
        ch.classList.add('active'); ch.setAttribute('aria-pressed','true');
        $('#fPage').value=p;
      }
      persistFilters();
      renderGrid();
    };
  });

  // atajo: / para enfocar búsqueda
  window.addEventListener('keydown', (e)=>{
    if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey){
      e.preventDefault();
      $('#fSearch').focus();
    }
  });
}
function syncChipToSelect(){
  $$('#pageChips .chip').forEach(c=>{ c.classList.toggle('active', c.dataset.page===filters.page); c.setAttribute('aria-pressed', String(c.dataset.page===filters.page)); });
}
function renderGrid(){
  const g = $('#grid'); g.innerHTML='';
  let list = allCards.slice();

  if(filters.page){ list = list.filter(c=> c.pages.includes(filters.page)); }
  if(filters.rarity){ list = list.filter(c=> c.rarity===filters.rarity); }
  if(filters.q){ list = list.filter(c=> (c.name.toLowerCase().includes(filters.q) || c.id.includes(filters.q))); }

  const frag = document.createDocumentFragment();
  for(const c of list){
    const r = rarityMap.get(c.rarity);
    const card = document.createElement('article');
    card.className='card';
    const alt = `${c.name} — ${r.label}`;
    const img = c.file ? `<img loading="lazy" src="${c.file}" alt="${alt}" onerror="this.replaceWith(createPh('${c.name}'))">` : `<div class="placeholder">${c.name}</div>`;
    card.innerHTML = `
      <div class="media">
        ${img}
        ${c.foil ? `<i class="foil" aria-hidden="true"></i>`:''}
      </div>
      <div class="row">
        <div class="title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div>
        <span class="rar ${c.rarity}" style="margin-left:auto" aria-label="Rareza: ${r.label}">${r.label}</span>
      </div>
      <div class="row tiny muted">
        <span>${c.pages.map(p=>DATA.album.find(a=>a.pageId===p)?.title||p).join(' • ')}</span>
      </div>
      <div class="row">
        <button class="primary" data-k="${c.key}">Ver</button>
        <div class="sp"></div>
        <span class="muted tiny">Tengo: <b data-own="${c.key}">${own(c.key)}</b></span>
      </div>
    `;
    frag.appendChild(card);
  }
  g.appendChild(frag);
  $$('#grid [data-k]').forEach(btn=> btn.onclick = ()=> openDialog(btn.dataset.k));
  updateProgress();
}
function createPh(text){
  const d = document.createElement('div'); d.className='placeholder'; d.textContent = text; return d;
}
function openDialog(key){
  const c = allCards.find(x=>x.key===key); if(!c) return;
  const r = rarityMap.get(c.rarity);
  const dlg = $('#dlg');
  const media = $('#dlgMedia'); media.innerHTML='';
  const w = document.createElement('div'); w.className='media';
  w.innerHTML = c.file
    ? `<img loading="lazy" src="${c.file}" alt="${c.name}" onerror="this.replaceWith(createPh('${c.name}'))">`
    : `<div class="placeholder">${c.name}</div>`;
  if(c.foil) { const fx=document.createElement('i'); fx.className='foil'; fx.setAttribute('aria-hidden','true'); w.appendChild(fx); }
  media.appendChild(w);

  $('#dlgTitle').textContent = c.name;
  const rar = $('#dlgRarity'); rar.textContent = r.label; rar.className = 'rar ' + c.rarity; rar.setAttribute('aria-label', `Rareza: ${r.label}`);
  $('#dlgLore').textContent = c.lore || '';
  $('#dlgPages').textContent = c.pages.map(p=>DATA.album.find(a=>a.pageId===p)?.title||p).join(' • ') || '—';
  $('#dlgTags').textContent = (c.tags||[]).join(' • ') || '—';
  $('#dlgOwned').textContent = own(key);

  $('#btnMarkOwned').onclick = ()=>{ setOwn(key, own(key)+1); reflectOwn(key); };
  $('#btnRemoveOwned').onclick = ()=>{ setOwn(key, Math.max(0,own(key)-1)); reflectOwn(key); };

  // backdrop click to close
  dlg.addEventListener('click', onBackdrop);
  dlg.addEventListener('close', ()=> dlg.removeEventListener('click', onBackdrop));
  function onBackdrop(e){ const r = dlg.getBoundingClientRect(); if (e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom) dlg.close(); }

  dlg.showModal();

  function reflectOwn(k){
    $('#dlgOwned').textContent = own(k);
    const b = document.querySelector(`[data-own="${k}"]`); if (b) b.textContent = own(k);
    updateProgress();
  }
}
/* progreso general + dorados */
function updateProgress(){
  const totalKeys = allCards.length;
  const ownedUnique = allCards.filter(c=> own(c.key)>0).length;
  const percent = Math.round( ownedUnique / totalKeys * 100 );
  $('#bar').style.width = percent + '%';
  const pb = document.querySelector('.progress'); pb.setAttribute('aria-valuenow', String(percent));
  $('#albumProgress').textContent = `Álbum ${ownedUnique}/${totalKeys} (${percent}%)`;
  const goldCount = allCards.filter(c=> c.rarity==='gold' && own(c.key)>0).length;
  $('#goldCount').textContent = `Dorados ${goldCount}`;
}

/* ====== Sobres ====== */
function rollRarity(){
  const n = Math.random()*100;
  let acc = 0;
  for(const r of DATA.rarities){
    acc += r.packOdds;
    if(n < acc) return r.id;
  }
  return DATA.rarities.at(-1).id; // fallback
}
function openPack({ bonus=false }={}){
  const size = DATA.pack.size + (bonus && DATA.pack.bonusOnExtra ? 1 : 0);
  const picks = [];
  for(let i=0;i<size;i++){
    const rar = rollRarity();
    const pool = allCards.filter(c=> c.rarity===rar);
    const pick = pool[Math.floor(Math.random()*pool.length)];
    picks.push(pick);
    setOwn(pick.key, own(pick.key)+1);
  }
  renderGrid();
  showToast(`¡Sobre abierto!`, picks.map(p=>`<li>${escapeHtml(p.name)} <span class="rar ${p.rarity}">${rarityMap.get(p.rarity).label}</span></li>`).join(''), bonus);
}
$('#btnOpen').onclick = ()=> openPack({ bonus:false });

/* ====== Import/Export ====== */
$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(collection,null,2)], {type:'application/json'});
  const a = document.createElement('a'); const url = URL.createObjectURL(blob);
  a.href = url; a.download = 'coleccion_seven.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 0);
};
$('#btnImport').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = ()=>{
    const f = inp.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const loaded = JSON.parse(r.result);
        if (loaded && typeof loaded === 'object'){ collection = loaded; localStorage.setItem(storeKey, JSON.stringify(collection)); renderGrid(); showToast('Colección importada'); }
        else throw new Error('bad');
      }catch{ showToast('Archivo inválido'); }
    };
    r.readAsText(f);
  };
  inp.click();
};
$('#btnClear').onclick = ()=>{
  if(confirm('¿Borrar colección local?')){ collection={}; localStorage.removeItem(storeKey); renderGrid(); showToast('Colección borrada'); }
};

/* ====== Filtros en URL/localStorage ====== */
function persistFilters(){
  localStorage.setItem('seven:viewer:filters', JSON.stringify(filters));
  const u = new URL(location.href);
  setOrDel(u.searchParams, 'page', filters.page);
  setOrDel(u.searchParams, 'rarity', filters.rarity);
  setOrDel(u.searchParams, 'q', filters.q);
  history.replaceState(null,'',u);
}
function restoreFilters(){
  const u = new URL(location.href);
  const fromUrl = { page:u.searchParams.get('page')||'', rarity:u.searchParams.get('rarity')||'', q:u.searchParams.get('q')||'' };
  const fromLs = safeParse(localStorage.getItem('seven:viewer:filters')) || {};
  return { page: fromUrl.page || fromLs.page || '', rarity: fromUrl.rarity || fromLs.rarity || '', q: fromUrl.q || fromLs.q || '' };
}
function setOrDel(sp, k, v){ if (v) sp.set(k,v); else sp.delete(k); }

/* ====== Utils ====== */
function debounce(fn, ms=100){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ====== Toast ====== */
function showToast(title, htmlList='', bonus=false){
  const t = $('#toast');
  t.innerHTML = `
    <div class="row" style="gap:10px; align-items:flex-start">
      <strong>${escapeHtml(title)}</strong>
      ${bonus?'<span class="badge">Bonus</span>':''}
      <div class="sp"></div>
      <button class="ghost" onclick="this.closest('#toast').classList.remove('show')">Cerrar</button>
    </div>
    ${htmlList?`<ul class="tiny" style="margin:6px 0 0 18px; padding:0">${htmlList}</ul>`:''}
  `;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 3500);
}

/* ====== Arranque ====== */
initFilters();
renderGrid();

/* Exponer createPh para manejador inline */
window.createPh = createPh;
</script>
</body>
</html>
