// /kiosk/app.js ‚Äî Seven de Burgers ¬∑ Kiosko V2 (UX simplificada + gamificaci√≥n suave)
import { beep, toast } from '../shared/notify.js';
import * as DB from '../shared/db.js';
import { initThemeFromSettings, applyThemeLocal } from '../shared/theme.js';

// ===== Config & Flags ========================================================
const qs = new URLSearchParams(location.search);
const IS_TRAINING = qs.get('mode') === 'offline' || qs.get('mode') === 'test' || qs.get('prueba') === '1';
const IS_LEGACY   = qs.get('legacy') === '1';
const READONLY    = qs.get('ro') === '1';

const CURRENCY = 'MXN';
const PRICE_ENDING = 7; // est√©tica de precios (47, 57, 67, ...)
const DRINK_HINT_DELAY = 2200; // ms para mostrar nudge de bebidas
const MAX_MINIS_FOR_REWARD = 3; // gamificaci√≥n (3 minis ‚Üí nudge/sonido)

// ===== Estado global =========================================================
const state = {
  catalog: [],        // productos visibles (filtrados)
  allProducts: [],    // cat√°logo original (para tabs)
  categories: [],     // ['big','mini','combos','otros']
  selectedCat: 'big', // pesta√±a actual
  cart: [],           // [{id, name, price, qty, options: {...}}]
  hh: null,           // {active, endsAt, ...}
  eta: null,          // {minutes, source}
  readyFeed: [],      // ids/n√∫meros de orden listos (para feed opcional)
  nudgeTimer: null,   // timeout de bebidas
};

// ===== Utilidades ============================================================
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function money(n) {
  try {
    return n.toLocaleString('es-MX', { style: 'currency', currency: CURRENCY, maximumFractionDigits: 0 });
  } catch {
    return `$${Math.round(n)}`;
  }
}
function roundEnding(n) {
  // Redondea al entero m√°s cercano que termine en 7
  const base = Math.round(n);
  const mod = base % 10;
  const want = 7;
  if (mod === want) return base;
  const up = base + ((10 + want - mod) % 10);
  const down = base - ((mod - want + 10) % 10);
  // elige el m√°s cercano; si empata, usa hacia arriba
  return (Math.abs(up - n) <= Math.abs(down - n)) ? up : down;
}
function safe(fn, label='op') { try { return fn(); } catch(e){ console.warn(`[safe:${label}]`, e); } }

// ===== Bootstrap de tema (no bloqueante) ====================================
safe(()=>initThemeFromSettings({ defaultName:'Base' }), 'initTheme');

// ===== UI base ===============================================================
const app = document.getElementById('app');
app.innerHTML = `
  <header class="header">
    <div class="brand" id="btnHome">
      <div class="dot"></div>
      <div>
        <div style="font-size:16px;font-weight:800;letter-spacing:.4px;">Seven de Burgers</div>
        <div class="title-sub">Kiosko V2</div>
      </div>
    </div>
    <div class="row" id="statusRow">
      <span id="etaPill" class="k-badge">ETA ‚Äî ‚Ä¶</span>
      <span id="hhPill"  class="k-badge">Happy Hour</span>
      <button class="btn small ghost" id="btnThemeNext" title="Cambiar tema r√°pido">Tema</button>
    </div>
  </header>

  <main class="container">
    <div id="tabsBar" class="tabs tabs-sticky" role="tablist" aria-label="Categor√≠as"></div>

    <section id="cards" class="grid" aria-live="polite"></section>
  </main>

  <!-- Barra carrito -->
  <div id="cartBar" style="
    position:fixed;left:10px;right:10px;bottom:10px;z-index:1000;
    display:none;align-items:center;justify-content:space-between;gap:12px;
    padding:10px 12px;border:1px solid var(--stroke);
    background:linear-gradient(180deg,color-mix(in srgb,var(--panel1) 90%,black 10%),color-mix(in srgb,var(--panel2) 86%,black 14%));
    border-radius:14px; box-shadow: var(--shadow);
  ">
    <div class="row" id="cartSummary" style="gap:10px;min-width:0;">
      <span class="k-badge" id="cartCount">0</span>
      <span class="ellipsis">Carrito</span>
    </div>
    <div class="row">
      <span class="total" id="cartTotal">$0</span>
      <button class="btn ok" id="btnCheckout">Confirmar</button>
    </div>
  </div>

  <!-- Modal de personalizaci√≥n -->
  <div class="modal" id="customModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Personalizar">
    <div class="modal-card">
      <div class="modal-head">
        <strong id="mTitle">Personalizar</strong>
        <button class="btn small ghost" id="mClose">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="price" id="mPrice">$0</div>
          <div class="muted small" id="mHint">Ajusta a tu gusto</div>
        </div>
        <div class="hr"></div>

        <div class="field">
          <label>Extras</label>
          <ul class="ul-clean" id="mExtras"></ul>
        </div>

        <div class="field">
          <label>Aderezos</label>
          <ul class="ul-clean" id="mSauces"></ul>
        </div>

        <div class="field">
          <label>Sin / Cambios</label>
          <textarea id="mNotes" placeholder="Sin jitomate, poco picante, etc."></textarea>
        </div>

        <div class="field">
          <label>Maridaje sugerido</label>
          <div id="pairBox"></div>
        </div>
      </div>
      <div class="modal-foot">
        <div class="total-bar">
          <div class="row" style="gap:8px;">
            <button class="btn small ghost" id="mLess">‚Äì</button>
            <strong id="mQty" aria-live="polite">1</strong>
            <button class="btn small" id="mMore">+</button>
          </div>
          <button class="btn ok" id="mAdd">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Nudge de bebidas (no bloqueante) -->
  <div id="__drinkNudge" style="
    position:fixed; right:10px; bottom:86px; z-index:1002; display:none;
    background:color-mix(in srgb, var(--panel1) 92%, black 8%);
    border:1px solid var(--stroke); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
    max-width:70vw;
  ">
    <div class="row">
      <div class="dot"></div>
      <strong style="font-family:var(--font-display)">¬øAlgo para tomar?</strong>
    </div>
    <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
      <button class="btn tiny" data-nudge="naranja">Jugo de Naranja</button>
      <button class="btn tiny" data-nudge="zanahoria">Jugo de Zanahoria</button>
      <button class="btn tiny" data-nudge="refresco">Refresco</button>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastMsg"></span></div>
`;

// Hook r√°pido para el tema (carrusel de presets locales si existen)
$('#btnThemeNext')?.addEventListener('click', ()=>{
  safe(async()=>{
    const list = (await safe(()=>window.listThemes?.(), 'listThemes')) || [
      { name:'Base' }, { name:'Pixel Art' }, { name:'Retro Arcade' }, { name:'Y2K' }, { name:'D√≠a de Muertos' }
    ];
    const names = list.map(x=>x.name);
    const current = document.body.getAttribute('data-theme-name') || 'Base';
    const idx = (names.indexOf(current)+1) % names.length;
    applyThemeLocal(names[idx]);
    toast?.(`Tema: ${names[idx]}`);
  }, 'themeNext');
});

// ===== Cat√°logo (demo + carga remota opcional) ===============================
// TIP: si tienes DB.getProducts() o similar, √∫salo; si no, usa el fallback.
async function loadCatalog() {
  let products = [];
  await safe(async()=>{
    if (DB?.getProducts) {
      products = await DB.getProducts({ onlyActive:true });
    }
  }, 'getProducts');

  if (!Array.isArray(products) || products.length === 0) {
    // Fallback m√≠nimo (usa tus ids reales si ya los tienes)
    products = [
      { id:'starter', name:'Starter Burger', price:47, category:'big', icon:'üçî' },
      { id:'koopa',   name:'Koopa Crunch',   price:57, category:'big', icon:'üê¢' },
      { id:'fatality',name:'Fatality Flame', price:67, category:'big', icon:'üî•' },
      { id:'hadouken',name:'Hadouken',       price:77, category:'big', icon:'‚ö°' },
      { id:'final',   name:'Final Boss',     price:97, category:'big', icon:'üëë' },

      { id:'starter-mini', name:'Starter Mini', price:27, category:'mini', icon:'üßí' },
      { id:'koopa-mini',   name:'Koopa Mini',   price:37, category:'mini', icon:'üß™' },
      { id:'hadouken-mini',name:'Hadouken Mini',price:47, category:'mini', icon:'üéÆ' },

      { id:'combo-3minis', name:'Combo 3 Minis', price:97, category:'combos', icon:'üéØ' },
    ];
  }

  // aderezos a $5 y algunos extras demo
  const sauces = [
    { id:'cheddar',  name:'Aderezo Cheddar',   price:5 },
    { id:'chimi',    name:'Salsa Chimichurri', price:5 },
    { id:'chipotle', name:'Aderezo Chipotle',  price:5 },
  ];
  const extras = [
    { id:'bacon', name:'Tocino', price:12 },
    { id:'pine',  name:'Reb. de Pi√±a', price:8 },
    { id:'ham',   name:'Jam√≥n', price:10 },
    { id:'sausage',name:'Salchicha', price:10 },
    { id:'meat', name:'Carne extra 85g', price:22 },
  ];

  state.allProducts = products.map(p => ({ ...p, sauces, extras }));
  state.categories = Array.from(new Set(state.allProducts.map(p=>p.category)));
  if (!state.categories.includes(state.selectedCat)) state.selectedCat = state.categories[0] || 'big';
  applyFilter();
  renderTabs();
  renderCards();
}
function applyFilter() {
  state.catalog = state.allProducts.filter(p => p.category === state.selectedCat);
}

// ===== Tabs ==================================================================
function renderTabs() {
  const bar = $('#tabsBar');
  bar.innerHTML = '';
  state.categories.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'btn tab' + (cat===state.selectedCat ? ' is-active' : '');
    btn.role = 'tab';
    btn.ariaSelected = (cat===state.selectedCat ? 'true' : 'false');
    btn.textContent = cat === 'big' ? 'Burgers' :
                      cat === 'mini' ? 'Mini' :
                      cat === 'combos' ? 'Combos' : cat;
    btn.addEventListener('click', ()=>{
      state.selectedCat = cat;
      applyFilter();
      renderTabs();
      renderCards(true);
      window.scrollTo({ top:0, behavior:'smooth' });
    });
    bar.appendChild(btn);
  });
}

// ===== Cards ================================================================
function renderCards(flash=false) {
  const wrap = $('#cards');
  wrap.innerHTML = '';
  state.catalog.forEach(p=>{
    const price = money(p.price);
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="media"><div class="icon-img" aria-hidden="true" style="display:grid;place-items:center;font-size:48px">${p.icon || 'üçî'}</div></div>
      <h3 class="ellipsis" title="${p.name}">${p.name}</h3>
      <div class="row">
        <span class="price">${price}</span>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn small" data-a="quick">Ordenar r√°pido</button>
        <button class="btn small ghost" data-a="custom">Personalizar</button>
      </div>
    `;
    card.querySelector('[data-a="quick"]').addEventListener('click', ()=> quickAdd(p));
    card.querySelector('[data-a="custom"]').addEventListener('click', ()=> openCustomize(p));
    wrap.appendChild(card);
  });

  if (flash) {
    // peque√±o feedback visual al cambiar de tab
    wrap.animate([{opacity:.6},{opacity:1}],{duration:160,easing:'ease-out'});
  }
}

// ===== Carrito ==============================================================
// Modelo: line = { id, name, priceUnit, qty, options: { extras:[...], sauces:[...], notes }, total }
function findLineKey(line) {
  // separa por id + hash de opciones para ‚Äúmergear‚Äù iguales
  const key = line.id + '|' + JSON.stringify(line.options||{});
  return key;
}
function addToCart(line) {
  if (READONLY) return;
  // merge by key
  const key = findLineKey(line);
  const idx = state.cart.findIndex(l => findLineKey(l) === key);
  if (idx >= 0) {
    state.cart[idx].qty += line.qty;
    state.cart[idx].total = state.cart[idx].qty * state.cart[idx].priceUnit;
  } else {
    state.cart.push({ ...line, total: line.qty * line.priceUnit });
  }
  updateCartBar();
  gamifyMiniThree();
  scheduleDrinkNudge();
}
function quickAdd(p) {
  const priceUnit = getPriceWithHH(p.price);
  addToCart({
    id: p.id, name: p.name, priceUnit, qty: 1, options: {}
  });
  beep?.(); toast?.(`${p.name} agregado`);
}
function updateCartBar() {
  const count = state.cart.reduce((a,b)=>a+b.qty,0);
  const total = state.cart.reduce((a,b)=>a+b.total,0);
  $('#cartCount').textContent = String(count);
  $('#cartTotal').textContent = money(total);
  const show = count > 0;
  $('#cartBar').style.display = show ? 'flex' : 'none';
  document.body.classList.toggle('has-cart', show);
}
function clearCart() {
  state.cart = [];
  updateCartBar();
}

$('#btnCheckout').addEventListener('click', async ()=>{
  if (READONLY) return;
  if (state.cart.length === 0) { toast?.('Tu carrito est√° vac√≠o'); return; }

  const payload = {
    lines: state.cart.map(l => ({
      id: l.id, name: l.name, qty: l.qty, price: l.priceUnit, options: l.options||{}
    })),
    total: state.cart.reduce((a,b)=>a+b.total,0),
    createdAt: new Date(),
    source: 'kiosk',
    training: !!IS_TRAINING
  };

  try {
    if (IS_TRAINING) {
      beep?.(); toast?.('Modo PRUEBA: orden simulada ‚úÖ');
      clearCart();
      return;
    }
    const orderId = await DB.createOrder(payload);
    beep?.(); toast?.(`Orden creada #${orderId}`);
    // CTA: seguir pedido
    openTrackCTA(orderId);
    clearCart();
  } catch (e) {
    console.error(e);
    toast?.('No se pudo crear la orden');
  }
});

// ===== Gamificaci√≥n m√≠nima ===================================================
function gamifyMiniThree() {
  const minis = state.cart.filter(l => (l.id||'').includes('mini')).reduce((a,b)=>a+b.qty,0);
  if (minis >= MAX_MINIS_FOR_REWARD) {
    safe(()=>beep?.(), 'beepMini');
    toast?.('¬°Logro! Combo 3 minis desbloqueado');
  }
}
function scheduleDrinkNudge() {
  const hasDrink = state.cart.some(l => /jugo|refresco|bebida/i.test(l.name));
  if (hasDrink) return;
  clearTimeout(state.nudgeTimer);
  state.nudgeTimer = setTimeout(()=>{
    const n = $('#__drinkNudge');
    if (!n) return;
    n.style.display = 'block';
    n.animate([{transform:'translateY(8px)',opacity:.3},{transform:'translateY(0)',opacity:1}],{duration:180});
  }, DRINK_HINT_DELAY);
}
$('#__drinkNudge')?.addEventListener('click', (ev)=>{
  const t = ev.target.closest('button[data-nudge]');
  if (!t) return;
  const map = {
    naranja: { id:'drink-orange',  name:'Jugo de Naranja 500ml', price:25 },
    zanahoria:{ id:'drink-carrot',  name:'Jugo de Zanahoria 500ml', price:15 },
    refresco: { id:'drink-soda',    name:'Refresco', price:20 },
  };
  const p = map[t.dataset.nudge];
  addToCart({ id:p.id, name:p.name, priceUnit: p.price, qty:1, options:{} });
  $('#__drinkNudge').style.display = 'none';
});

// ===== Modal de personalizaci√≥n =============================================
const modal = $('#customModal');
let currentProd = null;
let mQty = 1;
function openCustomize(p) {
  currentProd = p;
  mQty = 1;
  $('#mTitle').textContent = p.name;
  $('#mPrice').textContent = money(getPriceWithHH(p.price) * mQty);
  $('#mNotes').value = '';
  renderOptions('#mExtras', p.extras||[]);
  renderOptions('#mSauces', p.sauces||[]);
  renderPairingChips(p);
  openModal();
}
function renderOptions(sel, list) {
  const ul = $(sel);
  ul.innerHTML = '';
  list.forEach(opt=>{
    const id = `${sel.slice(1)}_${opt.id}`;
    const li = document.createElement('li');
    li.style.display = 'contents';
    li.innerHTML = `
      <input type="checkbox" id="${id}" value="${opt.id}" />
      <label for="${id}">${opt.name}</label>
      <span class="tag">${money(opt.price)}</span>
    `;
    ul.appendChild(li);
  });
}
function renderPairingChips(p) {
  const box = $('#pairBox');
  box.innerHTML = '';
  // heur√≠stica simple por categor√≠a
  const suggestions = (p.category==='big' || p.category==='mini')
    ? ['Jugo de Naranja','Refresco','Papas','Salsa Chimichurri']
    : ['Refresco','Papas','Ketchup'];
  suggestions.forEach(s=>{
    const btn = document.createElement('button');
    btn.className = 'btn tiny';
    btn.textContent = s;
    btn.addEventListener('click', ()=>{
      if (/jugo/i.test(s)) {
        addToCart({ id:'drink-orange', name:'Jugo de Naranja 500ml', priceUnit:25, qty:1, options:{} });
      } else if (/refresco/i.test(s)) {
        addToCart({ id:'drink-soda', name:'Refresco', priceUnit:20, qty:1, options:{} });
      } else if (/papas/i.test(s)) {
        addToCart({ id:'fries', name:'Papas', priceUnit:27, qty:1, options:{} });
      } else if (/chimichurri/i.test(s)) {
        // agrega aderezo como l√≠nea aparte (o podr√≠as usar options)
        addToCart({ id:'sauce-chimi', name:'Salsa Chimichurri', priceUnit:5, qty:1, options:{} });
      }
      toast?.(`${s} agregado`);
    });
    box.appendChild(btn);
  });
}
function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
$('#mClose').addEventListener('click', closeModal);
modal.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

$('#mLess').addEventListener('click', ()=>{ if (mQty>1){ mQty--; updateMPrice(); } });
$('#mMore').addEventListener('click', ()=>{ mQty++; updateMPrice(); });
function updateMPrice() {
  const base = getPriceWithHH(currentProd.price);
  const add = sumChecked('#mExtras') + sumChecked('#mSauces');
  $('#mQty').textContent = String(mQty);
  $('#mPrice').textContent = money((base + add) * mQty);
}
function sumChecked(sel) {
  let sum = 0;
  $$(sel+' input[type=checkbox]:checked').forEach(ch=>{
    const list = sel.endsWith('Extras') ? currentProd.extras : currentProd.sauces;
    const opt = (list||[]).find(o=>o.id===ch.value);
    if (opt) sum += opt.price;
  });
  return sum;
}
$('#mExtras').addEventListener('change', updateMPrice);
$('#mSauces').addEventListener('change', updateMPrice);

$('#mAdd').addEventListener('click', ()=>{
  if (!currentProd) return;
  const base = getPriceWithHH(currentProd.price);
  const selectedExtras = $$('#mExtras input[type=checkbox]:checked').map(x=>x.value);
  const selectedSauces = $$('#mSauces input[type=checkbox]:checked').map(x=>x.value);
  const add = sumChecked('#mExtras') + sumChecked('#mSauces');

  const line = {
    id: currentProd.id,
    name: currentProd.name,
    priceUnit: base + add,
    qty: mQty,
    options: {
      extras: selectedExtras,
      sauces: selectedSauces,
      notes: $('#mNotes').value.trim()
    }
  };
  addToCart(line);
  closeModal();
  toast?.(`${currentProd.name} agregado`);
});

// ===== Happy Hour / ETA (opt-in, no rompe si no existe) ======================
function getPriceWithHH(price) {
  if (state.hh?.active) {
    // HH solo aplica al precio base (no extras)
    const hhPrice = Math.max(1, Math.round(price * (state.hh.discount||1)));
    return roundEnding(hhPrice);
  }
  return roundEnding(price);
}
function updateHHPill() {
  const el = $('#hhPill');
  if (!state.hh || !state.hh.active) {
    el.textContent = 'Happy Hour ‚Äî inactivo';
    el.className = 'k-badge';
    return;
  }
  el.textContent = 'Happy Hour ‚Äî activo';
  el.className = 'k-badge ok';
}
function updateETAPill() {
  const el = $('#etaPill');
  const m = state.eta?.minutes;
  if (!m) { el.textContent = 'ETA ‚Äî ‚Ä¶'; return; }
  el.textContent = `ETA ‚Äî ${m} min`;
  el.className = m <= 8 ? 'k-badge ok' : (m <= 15 ? 'k-badge warn' : 'k-badge');
}
safe(async()=>{
  if (DB.subscribeHappyHour) {
    DB.subscribeHappyHour(hh=>{
      state.hh = hh;
      updateHHPill();
      // Recalcular totales existentes (solo base? aqu√≠ dejamos totales tal cual para no ‚Äúmutar‚Äù carrito a mitad)
      // UX: solo afecta nuevos agregados
    });
  }
  if (DB.subscribeEta) {
    DB.subscribeEta(eta=>{
      state.eta = eta;
      updateETAPill();
    });
  }
}, 'subsHH_ETA');

// ===== CTA de seguimiento tras confirmar =====================================
function openTrackCTA(orderId) {
  // Puedes abrir un modal de ‚Äúseguir pedido ahora‚Äù
  const url = new URL('../kiosk/track.html', location.origin);
  url.searchParams.set('oid', orderId);
  // Reutilizamos el toast como CTA sutil
  toast?.('Tu pedido est√° en preparaci√≥n. Toca aqu√≠ para seguirlo.');
  $('#toast')?.addEventListener('click', ()=> location.href = url.toString(), { once:true });
}

// ===== Accesibilidad b√°sica ==================================================
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape' && modal.classList.contains('open')) closeModal();
});

// ===== Inicio ================================================================
await loadCatalog();
updateCartBar();
updateHHPill();
updateETAPill();

// ===== LEGACY/PRUEBA banners (solo informativo) =============================
if (IS_TRAINING) {
  const tag = document.createElement('div');
  tag.className = 'badge';
  tag.textContent = 'MODO PRUEBA';
  document.body.appendChild(tag);
}
if (IS_LEGACY) {
  const tag = document.createElement('div');
  tag.className = 'badge';
  tag.textContent = 'LEGACY ON';
  document.body.appendChild(tag);
}
