<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Cocina — Seven (Monitor XL)</title>

  <style>
    html, body{
      margin:0;
      padding:0;
      height:100%;
      background:#020714;
      color:#f7f8ff;
      font-family:-apple-system,BlinkMacSystemFont,system-ui,
                  "Segoe UI",Roboto,Arial,sans-serif;
      font-size:18px;
      -webkit-text-size-adjust:100%;
    }
    body{
      overflow-y:scroll;
      -webkit-overflow-scrolling:touch;
    }
    .wrap{
      max-width:960px;
      margin:8px auto 16px;
      padding:0 10px 16px;
    }
    h1{
      margin:4px 0 10px;
      font-size:32px;
      font-weight:900;
      color:#ffc242;
      text-shadow:0 2px 4px rgba(0,0,0,.6);
    }
    h2{
      margin:10px 0 4px;
      font-size:22px;
      font-weight:800;
      color:#cfd8ff;
    }
    .section-label{
      font-size:16px;
      color:#8fa0c8;
      margin-bottom:4px;
    }
    .col{
      margin-bottom:14px;
      padding:8px;
      border-radius:14px;
      background:#060b18;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 8px 18px rgba(0,0,0,.45) inset;
    }
    .ord{
      margin-bottom:10px;
      padding:10px 10px 8px;
      border-radius:12px;
      background:#0b1424;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 6px 10px rgba(0,0,0,.45);
    }
    .ord:last-child{ margin-bottom:0; }

    .ord-header{
      font-size:18px;
      font-weight:700;
      color:#ffffff;
      margin-bottom:4px;
    }
    .ord-meta{
      font-size:16px;
      color:#9fb0d8;
      margin-bottom:4px;
    }
    .ord-total{
      font-size:18px;
      font-weight:800;
      color:#ffc242;
      margin-bottom:6px;
    }
    .muted{
      color:#9fb0d8;
      font-size:16px;
    }
    .small{ font-size:15px; }

    .items{
      margin:4px 0 2px;
      padding-left:14px;
    }
    .item-name{
      font-weight:700;
      font-size:17px;
      color:#ffffff;
    }
    .item-notes{
      font-size:15px;
      color:#ffdd88;
    }
    .ingredients{
      margin:2px 0 4px 0;
      padding-left:16px;
      list-style:disc;
      color:#dfe7ff;
      font-size:16px;
    }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      font-size:14px;
      color:#ffec9c;
      margin-left:4px;
    }

    .empty{
      padding:6px 0 2px;
      font-size:16px;
      color:#55648a;
    }

    @media (max-width:768px){
      body{ font-size:19px; }
      h1{ font-size:30px; }
      h2{ font-size:21px; }
      .ord-header{ font-size:18px; }
      .ord-total{ font-size:19px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Cocina — Seven (Monitor XL)</h1>

  <div class="col">
    <h2>Pendientes</h2>
    <div class="section-label">Pedidos nuevos por preparar</div>
    <div id="col-pending"></div>
  </div>

  <div class="col">
    <h2>En progreso</h2>
    <div class="section-label">Tomados por cocina</div>
    <div id="col-progress"></div>
  </div>

  <div class="col">
    <h2>Listos</h2>
    <div class="section-label">Para entregar al cliente</div>
    <div id="col-ready"></div>
  </div>

  <div class="col">
    <h2>Por cobrar</h2>
    <div class="section-label">Entregados sin marcar pagado</div>
    <div id="col-bill"></div>
  </div>
</div>

<!-- Firebase v8: compat Safari/iPad vieja -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
(function(){
  // ====== Init Firebase ======
  var firebaseConfig = {
    apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
    authDomain: "seven-de-burgers.firebaseapp.com",
    databaseURL: "https://seven-de-burgers-default-rtdb.firebaseio.com",
    projectId: "seven-de-burgers",
    storageBucket: "seven-de-burgers.appspot.com",
    messagingSenderId: "34089845279",
    appId: "1:34089845279:web:d13440c34e6bb7fa910b2a"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  var fs = null, rtdb = null;
  try{ fs = firebase.firestore(); }catch(e){}
  try{ rtdb = firebase.database(); }catch(e){}

  // ====== Detectar colección como en db.js ======
  function getOrdersCollection(){
    var path = location.pathname.split('/');
    var clean = [];
    for (var i=0;i<path.length;i++){ if (path[i]) clean.push(path[i]); }
    var idx = -1;
    for (var j=0;j<clean.length;j++){ if (clean[j] === 'v2'){ idx = j; break; } }

    var basePrefix;
    if (idx >= 0){
      // ej: /prueba/v2/ => "prueba/v2/orders"
      var slice = [];
      for (var k=0;k<=idx;k++){ slice.push(clean[k]); }
      basePrefix = slice.join('/'); // sin slashes
      return basePrefix + '/orders';
    }
    // producción sin /prueba/v2/
    return 'orders';
  }
  var ORDERS_COLLECTION = getOrdersCollection();

  // ====== Helpers ======
  function esc(s){
    return String(s || '').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
    });
  }
  function money(n){ return '$' + Number(n || 0).toFixed(0); }

  function isPaid(o){
    if (!o) return false;
    var raw = (o.paid != null ? o.paid : null);
    if (raw == null && o.payment && o.payment.paid != null) raw = o.payment.paid;
    if (raw == null && o.meta && o.meta.paid != null)       raw = o.meta.paid;
    if (raw == null && o.payStatus != null)                 raw = o.payStatus;

    if (raw === true || raw === 1) return true;
    if (typeof raw === "string"){
      var s = raw.toLowerCase().trim();
      if (s === "true" || s === "1" || s === "paid" || s === "pagado") return true;
    }

    var st = String(o.status || "").toUpperCase();
    if (st === "PAID") return true;
    if (o.paidAt || (o.payment && (o.payment.paidAt || o.payment.tx || o.payment.reference))) return true;
    return false;
  }

  function calcTotal(o){
    if (!o) return 0;
    if (typeof o.subtotal === "number"){
      return Number(o.subtotal || 0) + Number(o.tip || 0);
    }
    var s = 0;
    var items = Object.prototype.toString.call(o.items)==='[object Array]' ? o.items : [];
    for (var i=0;i<items.length;i++){
      var it = items[i] || {};
      var line = (typeof it.lineTotal === "number")
        ? Number(it.lineTotal || 0)
        : (Number(it.unitPrice || 0) * Number(it.qty || 1));
      s += line;
    }
    return s + Number(o.tip || 0);
  }

  function put(elId, list){
    var el = document.getElementById(elId);
    if (!el) return;
    if (!list || !list.length){
      el.innerHTML = '<div class="empty">Sin pedidos</div>';
      return;
    }
    var out = "";
    for (var i=0;i<list.length;i++){
      out += buildCard(list[i]);
    }
    el.innerHTML = out;
  }

  // ====== Render ======
  function buildCard(o){
    var items = Object.prototype.toString.call(o.items)==='[object Array]' ? o.items : [];
    var total = calcTotal(o);

    var type = String(o.orderType || o.mode || "").toLowerCase();
    var meta = "online";
    if (type === "dinein" || type === "mesa"){
      meta = "Mesa " + (o.table || "?");
    } else if (type === "pickup" || type === "local" || type === "pickup-online"){
      meta = "Para recoger";
    }

    var header = (o.shortId ? "#" + o.shortId + " " : "") +
                 (o.customer || o.customerName || "Cliente");

    var html = '<div class="ord">';
    html += '<div class="ord-header">' + esc(header) + '</div>';
    html += '<div class="ord-meta">' + esc(meta) + '</div>';
    html += '<div class="ord-total">Total aprox: ' + money(total) + '</div>';

    if (o.notes){
      html += '<div class="muted small"><b>Notas:</b> ' + esc(o.notes) + '</div>';
    }

    for (var i=0;i<items.length;i++){
      var it = items[i] || {};
      var name = (it.qty || 1) + '× ' + (it.name || 'Producto');

      html += '<div class="items">';
      html += '<div class="item-name">' + esc(name) + '</div>';

      if (it.notes){
        html += '<div class="item-notes">Nota: ' + esc(it.notes) + '</div>';
      }

      var ing = [];
      if (Object.prototype.toString.call(it.baseIngredients)==='[object Array]'){
        ing = it.baseIngredients;
      } else if (Object.prototype.toString.call(it.ingredients)==='[object Array]'){
        ing = it.ingredients;
      }
      if (ing && ing.length){
        html += '<ul class="ingredients">';
        for (var j=0;j<ing.length;j++){
          html += '<li>' + esc(ing[j]) + '</li>';
        }
        html += '</ul>';
      }

      if (it.extras){
        var ex = it.extras;
        if (ex.sauces && ex.sauces.length){
          html += '<div class="muted small">Aderezos: ' +
                  esc(ex.sauces.join(", ")) + '</div>';
        }
        if (ex.ingredients && ex.ingredients.length){
          html += '<div class="muted small">Extras: ' +
                  esc(ex.ingredients.join(", ")) + '</div>';
        }
        if (ex.dlcCarne){
          html += '<div class="muted small">+ DLC carne 85g</div>';
        }
        if (ex.seasoning){
          html += '<div class="muted small">Sazonador: ' +
                  esc(ex.seasoning) + '</div>';
        }
      }

      html += '</div>'; // .items
    }

    html += '</div>'; // .ord
    return html;
  }

  function render(list){
    list = Object.prototype.toString.call(list)==='[object Array]' ? list : [];

    var active = [];
    for (var i=0;i<list.length;i++){
      var o = list[i] || {};
      var st = String(o.status || "PENDING").toUpperCase();
      var total = calcTotal(o);
      var hasItems = o.items && o.items.length > 0;

      if (isPaid(o)) continue;
      if (total <= 0 || !hasItems) continue;
      if (st === "DONE" || st === "CANCELLED" || st === "PAID") continue;

      active.push(o);
    }

    var by = { PENDING:[], IN_PROGRESS:[], READY:[], BILL:[] };
    for (var j=0;j<active.length;j++){
      var o2 = active[j];
      var s2 = String(o2.status || "PENDING").toUpperCase();
      if (s2 === "DELIVERED") by.BILL.push(o2);
      else if (by[s2]) by[s2].push(o2);
      else by.PENDING.push(o2);
    }

    put("col-pending",  by.PENDING);
    put("col-progress", by.IN_PROGRESS);
    put("col-ready",    by.READY);
    put("col-bill",     by.BILL);
  }

  // ====== Firestore live (principal) ======
  if (fs){
    try{
      fs.collection(ORDERS_COLLECTION)
        .onSnapshot(function(snap){
          var list = [];
          snap.forEach(function(doc){
            var d = doc.data() || {};
            d.id = doc.id;
            list.push(d);
          });
          render(list);
        }, function(err){
          console.log("[monitor] Firestore error, uso RTDB fallback", err);
        });
    }catch(e){
      console.log("[monitor] Firestore init error, uso RTDB fallback", e);
    }
  }

  // ====== RTDB fallback ======
  if (rtdb){
    try{
      var RTDB_PATH = "kitchen/orders";
      rtdb.ref(RTDB_PATH).on("value", function(snap){
        var val = snap.val() || {};
        var keys = Object.keys(val);
        var list = [];
        for (var i=0;i<keys.length;i++){
          var id = keys[i];
          var o = val[id] || {};
          if (!o.id) o.id = id;
          list.push(o);
        }
        render(list);
      });
    }catch(e){
      console.log("[monitor] RTDB fallback error", e);
    }
  }
})();
</script>
</body>
</html>
