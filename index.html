<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Seven de Burgers Â· POS v7.5</title>
  <meta name="theme-color" content="#0b2540">
  <style>
    :root{--bg:#071a2c;--bg-2:#0b2540;--card:#0e2a47;--muted:#9bb3c8;--text:#eaf4ff;--accent:#ffd21f;--accent-2:#ff9f1c;--ok:#2dd4bf;--warn:#fb923c;--bad:#ef4444}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #103858 0%, var(--bg) 40%), var(--bg-2);letter-spacing:.2px}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(7,26,44,.95) 0%,rgba(7,26,44,.75) 100%);backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid #0f3557;padding:.6rem .9rem;display:flex;align-items:center;gap:.75rem;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800;letter-spacing:.5px}
    .brand .logo{width:28px;height:28px;border:2px solid var(--accent);border-radius:50%;display:grid;place-items:center;color:var(--accent)}
    .badge{background:rgba(255,210,31,.14);color:var(--accent);padding:.15rem .45rem;border:1px solid rgba(255,210,31,.25);border-radius:999px;font-size:.75rem}
    .tabs{display:flex;gap:.35rem;flex-wrap:wrap}
    .tab{border:1px solid #154e7e;background:#0a2140;color:var(--text);padding:.45rem .7rem;border-radius:.6rem;cursor:pointer;font-weight:600;font-size:.9rem}
    .tab[aria-selected="true"]{border-color:var(--accent);color:#0b0b0b;background:var(--accent)}
    main{max-width:1100px;margin:1rem auto;padding:0 .9rem 3rem}
    section{display:none}.active{display:block}
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin:.75rem 0}
    .pill{background:#0a203a;border:1px solid #153e65;padding:.35rem .6rem;border-radius:999px;color:var(--muted);font-size:.85rem}
    .btn{border:0;background:var(--accent);color:#08131f;font-weight:800;padding:.7rem 1rem;border-radius:.7rem;cursor:pointer}
    .btn.secondary{background:#113252;color:var(--text);border:1px solid #214b76}
    .btn.warn{background:var(--warn);color:#0b0b0b}.btn.ok{background:var(--ok);color:#073136}.btn.ghost{background:transparent;border:1px dashed #2a527d;color:var(--muted)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;gap:12px}.grid.cards{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:linear-gradient(180deg,#103454,#0b2643);border:1px solid #184a78;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.03)}
    .card h3{margin:.2rem 0 .35rem 0;font-size:1.05rem}
    .muted{color:var(--muted);font-size:.95rem}.price{font-weight:900;color:var(--accent)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .row-wrap{display:flex;flex-wrap:wrap;gap:6px}.tag{background:#0b223c;border:1px solid #1b456f;padding:.15rem .45rem;border-radius:7px;font-size:.85rem;color:#bbd1e5}
    input,select,textarea{width:100%;background:#0b223c;border:1px solid #1a446f;color:var(--text);padding:.75rem .8rem;border-radius:.7rem;font-size:1rem}
    small.help{color:#9db3c7;display:block;margin-top:.2rem}
    .status{font-size:.8rem;padding:.25rem .55rem;border-radius:999px;font-weight:700}
    .s-pend{background:#1e293b;border:1px solid #334155}.s-prep{background:#4338ca;color:#fff}.s-ready{background:#22c55e;color:#062814}.s-done{background:#0b223c;color:#8aa3ba;border:1px solid #203c5f}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,15,24,.55);backdrop-filter:blur(3px);z-index:60}.modal.active{display:grid}
    .sheet{width:min(560px, 96vw);background:#0b2038;border:1px solid #1a456f;border-radius:16px;padding:18px}
    .list{display:grid;gap:8px}
    .li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:.65rem .75rem;border-radius:.7rem;background:#0b2037;border:1px solid #183f67}
    /* iPhone-friendly big toggles */
    .toggle{display:flex;align-items:center;gap:10px;background:#0a1e36;border:1px solid #1a446f;border-radius:12px;padding:12px}
    .toggle input{width:24px;height:24px; accent-color:var(--accent)}
    .toggle label{flex:1; font-size:1.05rem; line-height:1.2}
    .toggle small{color:var(--muted);font-size:.9rem}
    /* Chips row for summary */
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#0b223c;border:1px solid #1a446f;color:#d7e6f7;border-radius:999px;padding:.25rem .55rem;font-size:.85rem}
    @media (max-width:420px){
      .btn{padding:.75rem 1rem;font-size:1rem}
      .toggle{padding:14px}
      .toggle input{width:26px;height:26px}
      .sheet{padding:16px;border-radius:14px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="logo">7</span>
      <div>
        <div style="font-size:.95rem; line-height:1; font-weight:900">Seven de Burgers</div>
        <div class="badge">POS Â· v7.5</div>
      </div>
    </div>
    <div class="tabs" id="tabs"><!-- tabs se inyectan dinÃ¡micamente --></div>
  </header>

  <main>
    <!-- KIOSKO -->
    <section id="kiosko" class="active">
      <div class="toolbar">
        <span class="pill">Vista pÃºblica Â· Precios visibles</span>
        <span id="mesaHint" class="pill">Mesa: â€”</span>
      </div>
      <div class="grid cards" id="kioskList"></div>
    </section>

    <!-- MESERO -->
    <section id="mesero">
      <div class="toolbar">
        <span class="pill" id="whoami">No has iniciado sesiÃ³n</span>
        <select id="mesaSelect" style="max-width:220px"></select>
      </div>
      <div class="grid cards" id="waiterList"></div>
    </section>

    <!-- COCINA -->
    <section id="cocina">
      <div class="toolbar">
        <span class="pill">Ã“rdenes en tiempo real</span>
        <label class="toggle" style="max-width:260px"><input type="checkbox" id="showDone"><label for="showDone" style="margin:0">Ver entregados</label></label>
      </div>
      <div class="grid" id="kitchenList" style="grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px"></div>
    </section>

    <!-- ADMIN -->
    <section id="admin">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px">
        <div class="card">
          <h3>Mesas</h3>
          <div class="row" style="gap:8px">
            <input id="newMesa" placeholder="NÃºmero / nombre de mesa">
            <button class="btn" id="addMesa">Agregar</button>
          </div>
          <div class="list" id="mesasList"></div>
        </div>

        <div class="card">
          <h3>Usuarios</h3>
          <div class="row" style="gap:8px">
            <input id="uNombre" placeholder="Nombre">
            <select id="uRol">
              <option value="mesero">Mesero</option>
              <option value="cocina">Cocina</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="row" style="gap:8px; margin-top:8px">
            <input id="uPin" placeholder="PIN (4 dÃ­gitos)" maxlength="4" pattern="[0-9]*">
            <button class="btn" id="addUser">Crear usuario</button>
          </div>
          <small class="help">Para kiosko no se requiere usuario.</small>
          <div class="list" id="usersList" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h3>Opciones</h3>
          <label class="toggle"><input type="checkbox" id="pricesVisible" checked><label for="pricesVisible">Mostrar precios en kiosko</label></label>
          <label class="toggle"><input type="checkbox" id="autoComplete" checked><label for="autoComplete">Ocultar Ã³rdenes entregadas</label></label>
          <button class="btn ghost" id="seedData">Cargar datos de demo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div class="modal" id="loginModal">
    <div class="sheet">
      <h2>Iniciar sesiÃ³n</h2>
      <div class="row" style="gap:8px">
        <select id="loginRole" style="max-width:160px">
          <option value="mesero">Mesero</option>
          <option value="cocina">Cocina</option>
          <option value="admin">Admin</option>
        </select>
        <input id="loginPin" placeholder="PIN" maxlength="4" pattern="[0-9]*">
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="doLogin">Entrar</button>
        <button class="btn secondary" id="cancelLogin">Cancelar</button>
      </div>
      <small class="help">Si no hay usuarios cargados, el PIN <b>1234</b> entra como Admin.</small>
    </div>
  </div>

  <div class="modal" id="orderModal">
    <div class="sheet" id="orderSheet"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, updateDoc, doc, deleteDoc, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
      authDomain: "seven-de-burgers.firebaseapp.com",
      projectId: "seven-de-burgers",
      storageBucket: "seven-de-burgers.firebasestorage.app",
      messagingSenderId: "34089845279",
      appId: "1:34089845279:web:d13440c34e6bb7fa910b2a",
      measurementId: "G-Q8YQJGL2XY"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // === DATA ===
    const BURGERS = [
      {id:'starter', name:'Starter Burger', price:47, suggested:'Mostaza dulce', ingredients:['Pan','Carne 85g','Queso amarillo','Queso blanco','Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup','Mostaza']},
      {id:'koopa', name:'Koopa Crunch', price:57, suggested:'Chimichurri', ingredients:['Pan','Carne','Queso blanco','PiÃ±a','Tocino','Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup','Mostaza']},
      {id:'flame', name:'Fatality Flame', price:67, suggested:'Habanero', ingredients:['Pan','Carne','Salsa Cheddar','Tocino','Salsa habanero','Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup','Mostaza']},
      {id:'mega', name:'Mega Byte', price:77, suggested:'Cheddar', ingredients:['Pan','Carne','Salsa Cheddar','Queso blanco','Tocino','Salchicha','Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup']},
      {id:'hadouken', name:'Hadouken', price:77, suggested:'Chipotle', ingredients:['Pan','Carne','Queso blanco','Queso amarillo','Salchicha','Aderezo chipotle','Lechuga','Jitomate','Cebolla']},
      {id:'nintendo', name:'Nintendo Nostalgia', price:67, suggested:'Mostaza dulce', ingredients:['Pan','Carne','Queso blanco','PiÃ±a','JamÃ³n','Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup','Mostaza']},
      {id:'final', name:'Final Boss Burger', price:97, suggested:'Chipotle + Habanero', ingredients:['Pan','Carne','Salsa Cheddar','Queso blanco','Queso amarillo','Tocino','JamÃ³n','Salchicha','PiÃ±a','Salsa habanero','Aderezo chipotle']},
    ];
    // Aderezos (8) a +$5 c/u
    const ADEREZOS = [
      {id:'ched', name:'Aderezo Cheddar', price:5},
      {id:'chip', name:'Aderezo Chipotle', price:5},
      {id:'haba', name:'Aderezo Habanero', price:5},
      {id:'chimi', name:'Salsa Chimichurri', price:5},
      {id:'most', name:'Mostaza dulce', price:5},
      {id:'jala', name:'JalapeÃ±o rostizado', price:5},
      {id:'curry', name:'Curry suave', price:5},
      {id:'secreta', name:'Salsa Secreta Seven', price:5},
    ];
    // Ingredientes extra
    const EXTRAS = [
      {id:'carne', name:'Carne extra (85g)', price:27},
      {id:'tocino', name:'Tocino', price:6},
      {id:'jamon', name:'JamÃ³n', price:5},
      {id:'salch', name:'Salchicha', price:8},
      {id:'pina', name:'PiÃ±a', price:5},
      {id:'cebcar', name:'Cebolla caramelizada', price:5},
    ];

    // === STATE ===
    let currentUser = null; // {id,name,role}
    let mesas = [];
    let users = [];
    let pricesVisible = true;

    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    const peso = v => `$${Number(v).toFixed(0)}`;

    // === Tabs control (bloquear acceso hasta login) ===
    function buildTabs(){
      const tabs = $('#tabs');
      tabs.innerHTML = '';
      // Siempre Kiosko + Login
      tabs.appendChild(tabBtn('Kiosko','kiosko', true));
      const login = document.createElement('button');
      login.className='tab'; login.id='loginBtn'; login.textContent='Login';
      login.addEventListener('click', ()=> $('#loginModal').classList.add('active'));
      tabs.appendChild(login);

      // Si hay usuario: agregar su(s) panel(es) y botÃ³n Salir
      if(currentUser){
        tabs.insertBefore(tabBtn('Mesero','mesero'), login);
        tabs.insertBefore(tabBtn('Cocina','cocina'), login);
        tabs.insertBefore(tabBtn('Admin','admin'), login);
        // Remover Login y poner Salir
        tabs.removeChild(login);
        const out = document.createElement('button');
        out.className='tab'; out.textContent='Salir';
        out.onclick = ()=>{ currentUser=null; buildTabs(); setTab('kiosko'); };
        tabs.appendChild(out);
      }
      setTab('kiosko');
    }
    function tabBtn(label, id, selected=false){
      const b = document.createElement('button');
      b.className='tab'; b.dataset.tab=id; b.setAttribute('aria-selected', String(selected));
      b.textContent = label;
      b.addEventListener('click', ()=> setTab(id));
      return b;
    }
    function setTab(id){
      $$('#tabs .tab').forEach(b=>b.setAttribute('aria-selected', String(b.dataset.tab===id)));
      $$('main section').forEach(s=>s.classList.remove('active'));
      const el = document.getElementById(id); if(el) el.classList.add('active');
      if(id==='kiosko') updateMesaHint();
      if(id==='mesero') renderWaiterMenu();
    }
    buildTabs();

    // === Login ===
    $('#cancelLogin').addEventListener('click', ()=> $('#loginModal').classList.remove('active'));
    $('#doLogin').addEventListener('click', async ()=>{
      const role = $('#loginRole').value;
      const pin  = $('#loginPin').value.trim();
      if(!pin){alert('PIN requerido');return}
      let found = users.find(u=>u.pin===pin && u.role===role);
      if(!found && pin==='1234'){ // bootstrap
        await addDoc(collection(db,'users'), {name:'Admin', role:'admin', pin:'1234', mesas:[], active:true, createdAt:serverTimestamp()});
        await loadUsers(); found = users.find(u=>u.pin==='1234');
      }
      if(!found){alert('Usuario o PIN invÃ¡lido');return}
      currentUser = found;
      $('#loginModal').classList.remove('active');
      buildTabs();
      if(role==='mesero') setTab('mesero');
      if(role==='cocina') setTab('cocina');
      if(role==='admin')  setTab('admin');
      renderWaiterMenu();
    });

    // === Settings ===
    function updateMesaHint(){
      const mesaParam = new URLSearchParams(location.search).get('mesa');
      $('#mesaHint').textContent = 'Mesa: ' + (mesaParam ?? 'â€”');
    }

    // Users & Mesas realtime
    async function loadUsers(){
      const qs = await getDocs(collection(db,'users'));
      users = qs.docs.map(d=>({id:d.id, ...d.data()}));
      renderUsers();
    }
    onSnapshot(collection(db,'mesas'), snap=>{
      mesas = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(m=>m.active!==false);
      renderMesas(); renderKiosk();
    });
    loadUsers();

    // ADMIN Renders
    function renderMesas(){
      const list = $('#mesasList'); list.innerHTML='';
      mesas.sort((a,b)=> (a.name+'').localeCompare(b.name+''));
      mesas.forEach(m=>{
        const row = document.createElement('div'); row.className='li';
        row.innerHTML = `<div>ðŸª‘ Mesa <b>${m.name}</b></div>
          <div class="row">
            <button class="btn secondary" data-del="${m.id}">Eliminar</button>
          </div>`;
        row.querySelector('[data-del]').onclick = ()=> deleteDoc(doc(db,'mesas',m.id));
        list.appendChild(row);
      });
      const sel = $('#mesaSelect'); sel.innerHTML='<option value="">â€” Mesa â€”</option>'+mesas.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
    }
    function renderUsers(){
      const list = $('#usersList'); list.innerHTML='';
      users.forEach(u=>{
        const row = document.createElement('div'); row.className='li';
        row.innerHTML = `<div>ðŸ‘¤ <b>${u.name}</b> Â· ${u.role} <span class="muted">PIN ${u.pin}</span></div>
        <div class="row"><button class="btn secondary" data-del="${u.id}">Eliminar</button></div>`;
        row.querySelector('[data-del]').onclick = ()=> deleteDoc(doc(db,'users',u.id));
        list.appendChild(row);
      });
    }
    // Admin actions
    $('#addMesa').addEventListener('click', async ()=>{
      const name = $('#newMesa').value.trim(); if(!name) return;
      await addDoc(collection(db,'mesas'), {name, active:true, createdAt:serverTimestamp()}); $('#newMesa').value='';
    });
    $('#addUser').addEventListener('click', async ()=>{
      const name=$('#uNombre').value.trim(), role=$('#uRol').value, pin=$('#uPin').value.trim();
      if(!name||!pin) return alert('Nombre y PIN'); await addDoc(collection(db,'users'), {name, role, pin, mesas:[], active:true, createdAt:serverTimestamp()});
      $('#uNombre').value=''; $('#uPin').value='';
    });
    $('#seedData').addEventListener('click', async()=>{
      if(!confirm('Cargar datos de demo (mesas y usuarios)?')) return;
      for(const n of [1,2,3,4]) await addDoc(collection(db,'mesas'), {name:String(n), active:true, createdAt:serverTimestamp()});
      await addDoc(collection(db,'users'), {name:'Alex', role:'mesero', pin:'1111', mesas:[1,2], active:true, createdAt:serverTimestamp()});
      await addDoc(collection(db,'users'), {name:'Cocina', role:'cocina', pin:'2222', mesas:[], active:true, createdAt:serverTimestamp()});
      await addDoc(collection(db,'users'), {name:'Admin', role:'admin', pin:'1234', mesas:[], active:true, createdAt:serverTimestamp()});
      alert('Listo. Recarga para verlos.');
    });

    // === Kiosko ===
    function renderKioskCard(b){
      const priceTxt = `<span class="price">${peso(b.price)}</span>`;
      const ingr = b.ingredients.slice(0,5).join(' â€¢ ') + 'â€¦';
      return `<div class="card">
        <div class="row"><h3>${b.name}</h3>${priceTxt}</div>
        <div class="muted" style="min-height:40px">${ingr}</div>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-order="${b.id}">Ordenar</button>
          <button class="btn secondary" data-info="${b.id}">Ingredientes</button>
        </div>
      </div>`;
    }
    function renderKiosk(){
      const box = $('#kioskList'); box.innerHTML = BURGERS.map(renderKioskCard).join('');
      box.querySelectorAll('[data-info]').forEach(btn=> btn.onclick = ()=> showInfo(btn.dataset.info, 'kiosk'));
      box.querySelectorAll('[data-order]').forEach(btn=> btn.onclick = ()=> openOrderModal(btn.dataset.order, 'kiosk'));
    }
    renderKiosk();

    // === Mesero ===
    function renderWaiterMenu(){
      const box = $('#waiterList'); box.innerHTML='';
      BURGERS.forEach(b=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row"><h3>${b.name}</h3><span class="price">${peso(b.price)}</span></div>
          <div class="muted" style="min-height:40px">${b.ingredients.join(' â€¢ ')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-order="${b.id}">Enviar a cocina</button>
            <button class="btn secondary" data-info="${b.id}">Ingredientes</button>
          </div>`;
        card.querySelector('[data-info]').onclick = ()=> showInfo(b.id, 'mesero');
        card.querySelector('[data-order]').onclick = ()=> openOrderModal(b.id, 'mesero', {mesa: $('#mesaSelect').value});
        box.appendChild(card);
      });
    }

    // Info modal
    function showInfo(id, ctx){
      const b = BURGERS.find(x=>x.id===id);
      const html = `
        <h2>${b.name} <span class="price">${peso(b.price)}</span></h2>
        <div class="muted">Ingredientes: ${b.ingredients.join(' â€¢ ')}</div>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="omOrder">Ordenar</button>
          <button class="btn secondary" id="omClose">Cerrar</button>
        </div>`;
      $('#orderSheet').innerHTML = html;
      $('#orderModal').classList.add('active');
      $('#omClose').onclick = ()=> $('#orderModal').classList.remove('active');
      $('#omOrder').onclick = ()=> { $('#orderModal').classList.remove('active'); openOrderModal(id, ctx); }
    }

    // Util: big toggles with ids for iOS
    function mkToggle(id, label, price){
      const uid = `${id}-${Math.random().toString(36).slice(2,8)}`;
      return `<div class="toggle"><input id="${uid}" type="checkbox" data-id="${id}" data-p="${price}"><label for="${uid}">${label}${price?` <small>(+${peso(price)})</small>`:''}</label></div>`;
    }

    // Order modal
    function openOrderModal(id, ctx, opts={}){
      const mesaParam = opts.mesa || new URLSearchParams(location.search).get('mesa') || '';
      const b = BURGERS.find(x=>x.id===id);
      const adz = ADEREZOS.map(a=> mkToggle('adz:'+a.id, a.name, a.price)).join('');
      const exs = EXTRAS.map(a=> mkToggle('ex:'+a.id, a.name, a.price)).join('');
      const sins = ['Lechuga','Jitomate','Cebolla','Mayonesa','CÃ¡tsup','Mostaza']
                   .map(s=> mkToggle('sin:'+s, 'Sin '+s, 0)).join('');

      const html = `
        <h2>${b.name} Â· <span class="price">${peso(b.price)}</span></h2>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="gap:8px; margin:.6rem 0">
          <input id="omNombre" placeholder="Nombre del cliente">
          <input id="omMesa" placeholder="Mesa" value="${mesaParam||''}" style="max-width:140px">
        </div>

        <div class="card">
          <h3>Aderezos extra</h3>
          <div class="list" id="adzList">${adz}</div>
          ${mkToggle('surprise','Â¿Te sorprendemos con un aderezo? (+$5)',0)}
        </div>

        <div class="card" style="margin-top:10px">
          <h3>Ingredientes extra</h3>
          <div class="list" id="exList">${exs}</div>
        </div>

        <div class="card" style="margin-top:10px">
          <h3>Quitar ingredientes</h3>
          <div class="list" id="sinList">${sins}</div>
        </div>

        <textarea id="omNotas" rows="2" placeholder="Notas a cocina (ej. sin jitomate, pan extra dorado)"></textarea>

        <div class="row" style="margin-top:10px">
          <div id="omTotal" class="price">${peso(b.price)}</div>
          <div id="omChips" class="chips"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn" id="omSend">${ctx==='kiosk'?'Enviar pedido':'Enviar a cocina'}</button>
          <button class="btn secondary" id="omCancel">Cancelar</button>
        </div>`;

      $('#orderSheet').innerHTML = html;
      $('#orderModal').classList.add('active');
      $('#omCancel').onclick = ()=> $('#orderModal').classList.remove('active');

      function parseSelections(){
        const ch = [...$('#orderSheet').querySelectorAll('input[type=checkbox]')];
        const selAdz = ch.filter(i=>i.dataset.id?.startsWith('adz:') && i.checked);
        const selEx  = ch.filter(i=>i.dataset.id?.startsWith('ex:') && i.checked);
        const selSin = ch.filter(i=>i.dataset.id?.startsWith('sin:') && i.checked);
        const surprise = ch.find(i=>i.dataset.id==='surprise')?.checked || false;

        let total = b.price;
        const chips=[];

        selAdz.forEach(i=>{ total += Number(i.dataset.p||0); chips.push(`Aderezo: ${i.parentElement.querySelector('label').textContent.replace(/\s*\(\+\$\d+\)\s*/,'')}`) });
        selEx.forEach(i=>{ total += Number(i.dataset.p||0); chips.push(`Extra: ${i.parentElement.querySelector('label').textContent.replace(/\s*\(\+\$\d+\)\s*/,'')}`) });
        if(surprise){ total += 5; chips.push('Sorpresa +$5'); }

        $('#omTotal').textContent = peso(total);
        const chipsBox = $('#omChips'); chipsBox.innerHTML = chips.map(t=>`<span class="chip">${t}</span>`).join('');

        return {
          adz: selAdz.map(i=>{
            const id=i.dataset.id.split(':')[1];
            const meta = ADEREZOS.find(a=>a.id===id); return {id, name:meta.name, price:Number(i.dataset.p||0)};
          }),
          ex: selEx.map(i=>{
            const id=i.dataset.id.split(':')[1];
            const meta = EXTRAS.find(a=>a.id===id); return {id, name:meta.name, price:Number(i.dataset.p||0)};
          }),
          sin: selSin.map(i=> i.dataset.id.split(':')[1].replace(/^sin:/,'')),
          surprise,
          total
        };
      }

      $('#orderSheet').addEventListener('change', parseSelections);
      parseSelections();

      $('#omSend').onclick = async ()=>{
        const nombre = $('#omNombre').value.trim();
        const mesa   = $('#omMesa').value.trim() || 'â€”';
        const notas  = $('#omNotas').value.trim();
        const sel = parseSelections();

        const docData = {
          ctx, mesa, customer:nombre||null,
          burger:{id:b.id, name:b.name, basePrice:b.price, ingredients:b.ingredients, suggested:b.suggested},
          extras: sel.ex,
          addOns: sel.adz,
          surprise: sel.surprise,
          remove: sel.sin,
          notes: notas || null,
          price: sel.total,
          status:'pendiente',
          createdAt: serverTimestamp(),
          meseroId: currentUser?.id || null,
          mesero: currentUser?.name || 'Kiosko'
        };
        await addDoc(collection(db,'orders'), docData);
        $('#orderModal').classList.remove('active');
        alert('Â¡Pedido enviado!');
      };
    }

    // === Cocina realtime ===
    const kitchenQ = query(collection(db,'orders'), orderBy('createdAt','desc'));
    onSnapshot(kitchenQ, snap=>{
      const showDone = $('#showDone').checked;
      const list = $('#kitchenList'); list.innerHTML='';
      snap.docs.forEach(d=>{
        const o = {id:d.id, ...d.data()};
        if(!showDone && o.status==='entregado') return;
        const statusBadge = {pendiente:'status s-pend', preparando:'status s-prep', listo:'status s-ready', entregado:'status s-done'}[o.status] || 'status s-pend';
        const ing = (o.burger?.ingredients||[]).filter(x=>!(o.remove||[]).includes(x)).join(' â€¢ ');
        const adz = (o.addOns||[]).map(a=>a.name).join(' â€¢ ');
        const exs = (o.extras||[]).map(a=>a.name).join(' â€¢ ');
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row"><h3>${o.burger?.name||'â€”'}</h3><span class="${statusBadge}">${o.status}</span></div>
          <div class="muted">Mesa: <b>${o.mesa||'â€”'}</b> Â· ${o.customer?('Cliente: <b>'+o.customer+'</b>'):''}</div>
          <div class="muted" style="margin-top:6px"><b>Ingredientes:</b> ${ing || 'â€”'}</div>
          ${adz?`<div class="muted"><b>Aderezos:</b> ${adz}</div>`:''}
          ${exs?`<div class="muted"><b>Extras:</b> ${exs}</div>`:''}
          ${o.surprise?`<div class="muted"><b>Sorpresa:</b> 1 aderezo a elecciÃ³n del chef</div>`:''}
          ${o.remove?.length?`<div class="muted"><b>Quitar:</b> ${(o.remove||[]).join(' â€¢ ')}</div>`:''}
          ${o.notes?`<div class="muted"><b>Notas:</b> ${o.notes}</div>`:''}
          <div class="row" style="margin-top:8px">
            ${o.status!=='preparando'?'<button class="btn" data-act="preparando">Preparar</button>':''}
            ${o.status!=='listo'?'<button class="btn ok" data-act="listo">Listo</button>':''}
            <button class="btn warn" data-act="entregado">Entregar</button>
          </div>`;
        card.querySelectorAll('[data-act]').forEach(b=> b.onclick = ()=> updateDoc(doc(db,'orders',o.id), {status:b.dataset.act}));
        list.appendChild(card);
      });
    });

    // Inicial
    function initMesaParam(){ const mesaParam = new URLSearchParams(location.search).get('mesa'); if(mesaParam) $('#mesaHint').textContent = 'Mesa: '+mesaParam; }
    initMesaParam();
  </script>
</body>
</html>
