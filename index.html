<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seven de Burgers · POS v7.4</title>
  <meta name="theme-color" content="#0b2540">
  <style>
    :root{
      --bg:#071a2c;
      --bg-2:#0b2540;
      --card:#0e2a47;
      --muted:#9bb3c8;
      --text:#eaf4ff;
      --accent:#ffd21f;
      --accent-2:#ff9f1c;
      --ok:#2dd4bf;
      --warn:#fb923c;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #103858 0%, var(--bg) 40%), var(--bg-2);
      letter-spacing:.2px;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(7,26,44,.95) 0%, rgba(7,26,44,.75) 100%);
      backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid #0f3557;
      padding:.6rem .9rem;
      display:flex; align-items:center; gap:.75rem; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:.6rem; font-weight:800; letter-spacing:.5px}
    .brand .logo{width:28px;height:28px;border:2px solid var(--accent); border-radius:50%; display:grid; place-items:center; font-weight:900; color:var(--accent);}
    .badge{background:rgba(255,210,31,.14); color:var(--accent); padding:.15rem .45rem; border:1px solid rgba(255,210,31,.25); border-radius:999px; font-size:.75rem;}

    .tabs{display:flex; gap:.35rem; flex-wrap:wrap}
    .tab{
      border:1px solid #154e7e; background:#0a2140; color:var(--text);
      padding:.45rem .7rem; border-radius:.6rem; cursor:pointer; font-weight:600; font-size:.9rem;
    }
    .tab[aria-selected="true"]{border-color:var(--accent); color:#0b0b0b; background:var(--accent);}
    main{max-width:1100px; margin:1rem auto; padding:0 .9rem 3rem;}
    section{display:none;}
    section.active{display:block;}

    .toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.75rem 0;}
    .pill{background:#0a203a; border:1px solid #153e65; padding:.35rem .6rem; border-radius:999px; color:var(--muted); font-size:.85rem;}
    .btn{border:0; background:var(--accent); color:#08131f; font-weight:800; padding:.6rem .9rem; border-radius:.6rem; cursor:pointer;}
    .btn.secondary{background:#113252; color:var(--text); border:1px solid #214b76;}
    .btn.warn{background:var(--warn); color:#0b0b0b}
    .btn.ok{background:var(--ok); color:#073136}
    .btn.ghost{background:transparent; border:1px dashed #2a527d; color:var(--muted)}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .grid{display:grid; gap:12px}
    .grid.cards{grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));}
    .card{
      background:linear-gradient(180deg,#103454, #0b2643);
      border:1px solid #184a78; border-radius:12px; padding:14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .card h3{margin:.2rem 0 .35rem 0; font-size:1.05rem}
    .muted{color:var(--muted); font-size:.9rem}
    .price{font-weight:900; color:var(--accent);}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .row-wrap{display:flex; flex-wrap:wrap; gap:6px}
    .tag{background:#0b223c; border:1px solid #1b456f; padding:.15rem .45rem; border-radius:7px; font-size:.8rem; color:#bbd1e5}
    input,select,textarea{
      width:100%; background:#0b223c; border:1px solid #1a446f; color:var(--text);
      padding:.55rem .6rem; border-radius:.5rem;
    }
    small.help{color:#9db3c7; display:block; margin-top:.2rem}
    .status{font-size:.75rem; padding:.15rem .45rem; border-radius:999px; font-weight:700}
    .s-pend{background:#1e293b; border:1px solid #334155}
    .s-prep{background:#4338ca; color:#fff}
    .s-ready{background:#22c55e; color:#062814}
    .s-done{background:#0b223c; color:#8aa3ba; border:1px solid #203c5f}

    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,15,24,.55); backdrop-filter:blur(3px); z-index:60}
    .modal.active{display:grid}
    .sheet{width:min(520px, 92vw); background:#0b2038; border:1px solid #1a456f; border-radius:14px; padding:18px}
    .sheet h2{margin:.2rem 0 1rem;}

    .list{display:grid; gap:6px}
    .list .li{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:.5rem .6rem; border-radius:.6rem; background:#0b2037; border:1px solid #183f67}
    .switch{display:inline-flex; align-items:center; gap:.45rem}
    .switch input{accent-color:var(--accent)}

    /* tiny icons */
    .ico{display:inline-block; width:1.15em; height:1.15em; vertical-align:-.2em; margin-right:.25em}
    .i-burger{background:conic-gradient(from 180deg at 50% 50%,#d2a55a 0 25%, #3f612d 0 35%, #803e2b 0 45%, #3f612d 0 55%, #d2a55a 0 100%); border-radius:3px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="logo">7</span>
      <div>
        <div style="font-size:.95rem; line-height:1; font-weight:900">Seven de Burgers</div>
        <div class="badge">POS · v7.4</div>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab" data-tab="kiosko" aria-selected="true">Kiosko</button>
      <button class="tab" data-tab="mesero">Mesero</button>
      <button class="tab" data-tab="cocina">Cocina</button>
      <button class="tab" data-tab="admin">Admin</button>
      <button class="tab" id="loginBtn">Login</button>
    </div>
  </header>

  <main>
    <!-- KIOSKO -->
    <section id="kiosko" class="active">
      <div class="toolbar">
        <span class="pill">Vista pública · Precios visibles</span>
        <span id="mesaHint" class="pill">Mesa: —</span>
      </div>
      <div class="grid cards" id="kioskList"></div>
    </section>

    <!-- MESERO -->
    <section id="mesero">
      <div class="toolbar">
        <span class="pill" id="whoami">No has iniciado sesión</span>
        <select id="mesaSelect" style="max-width:220px"></select>
        <button class="btn secondary" id="misMesasBtn">Solo mis mesas</button>
      </div>
      <div class="grid cards" id="waiterList"></div>
    </section>

    <!-- COCINA -->
    <section id="cocina">
      <div class="toolbar">
        <span class="pill">Órdenes en tiempo real</span>
        <label class="switch"><input type="checkbox" id="showDone"> Ver entregados</label>
      </div>
      <div class="grid" id="kitchenList" style="grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px"></div>
    </section>

    <!-- ADMIN -->
    <section id="admin">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px">
        <div class="card">
          <h3>Mesas</h3>
          <div class="row" style="gap:8px">
            <input id="newMesa" placeholder="Número / nombre de mesa">
            <button class="btn" id="addMesa">Agregar</button>
          </div>
          <div class="list" id="mesasList"></div>
        </div>

        <div class="card">
          <h3>Usuarios</h3>
          <div class="row" style="gap:8px">
            <input id="uNombre" placeholder="Nombre">
            <select id="uRol">
              <option value="mesero">Mesero</option>
              <option value="cocina">Cocina</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="row" style="gap:8px; margin-top:8px">
            <input id="uPin" placeholder="PIN (4 dígitos)" maxlength="4" pattern="[0-9]*">
            <button class="btn" id="addUser">Crear usuario</button>
          </div>
          <small class="help">Para kiosko no se requiere usuario.</small>
          <div class="list" id="usersList" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h3>Opciones</h3>
          <label class="switch"><input type="checkbox" id="pricesVisible" checked> Mostrar precios en kiosko</label>
          <label class="switch"><input type="checkbox" id="autoComplete" checked> Ocultar órdenes entregadas</label>
          <button class="btn ghost" id="seedData">Cargar datos de demo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div class="modal" id="loginModal">
    <div class="sheet">
      <h2>Iniciar sesión</h2>
      <div class="row" style="gap:8px">
        <select id="loginRole" style="max-width:160px">
          <option value="mesero">Mesero</option>
          <option value="cocina">Cocina</option>
          <option value="admin">Admin</option>
        </select>
        <input id="loginPin" placeholder="PIN" maxlength="4" pattern="[0-9]*">
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="doLogin">Entrar</button>
        <button class="btn secondary" id="cancelLogin">Cancelar</button>
      </div>
      <small class="help">Si no hay usuarios cargados, el PIN <b>1234</b> entra como Admin.</small>
    </div>
  </div>

  <div class="modal" id="orderModal">
    <div class="sheet" id="orderSheet"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, updateDoc, doc, deleteDoc, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAidr-9HSNlfok5BOBer8Te8EflyV8VYi4",
      authDomain: "seven-de-burgers.firebaseapp.com",
      projectId: "seven-de-burgers",
      storageBucket: "seven-de-burgers.firebasestorage.app",
      messagingSenderId: "34089845279",
      appId: "1:34089845279:web:d13440c34e6bb7fa910b2a",
      measurementId: "G-Q8YQJGL2XY"
    };

    // App
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- Datos base ---
    const BURGERS = [
      {id:'starter', name:'Starter Burger', price:47, suggested:'Mostaza dulce', ingredients:['Pan','Carne 85g','Queso amarillo','Queso blanco','Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup','Mostaza']},
      {id:'koopa', name:'Koopa Crunch', price:57, suggested:'Chimichurri', ingredients:['Pan','Carne','Queso blanco','Piña','Tocino','Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup','Mostaza']},
      {id:'flame', name:'Fatality Flame', price:67, suggested:'Habanero', ingredients:['Pan','Carne','Salsa Cheddar','Tocino','Salsa habanero','Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup','Mostaza']},
      {id:'mega', name:'Mega Byte', price:77, suggested:'Cheddar', ingredients:['Pan','Carne','Salsa Cheddar','Queso blanco','Tocino','Salchicha','Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup']},
      {id:'hadouken', name:'Hadouken', price:77, suggested:'Chipotle', ingredients:['Pan','Carne','Queso blanco','Queso amarillo','Salchicha','Aderezo chipotle','Lechuga','Jitomate','Cebolla']},
      {id:'nintendo', name:'Nintendo Nostalgia', price:67, suggested:'Mostaza dulce', ingredients:['Pan','Carne','Queso blanco','Piña','Jamón','Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup','Mostaza']},
      {id:'final', name:'Final Boss Burger', price:97, suggested:'Chipotle + Habanero', ingredients:['Pan','Carne','Salsa Cheddar','Queso blanco','Queso amarillo','Tocino','Jamón','Salchicha','Piña','Salsa habanero','Aderezo chipotle']},
    ];

    const ADEREZOS = [
      {id:'pina', name:'Piña', price:5},
      {id:'tocino', name:'Tocino', price:6},
      {id:'ched', name:'Aderezo Cheddar', price:5},
      {id:'haba', name:'Aderezo Habanero', price:5},
      {id:'chimi', name:'Aderezo Chimichurri', price:5},
      {id:'jamon', name:'Jamón', price:5},
      {id:'salch', name:'Salchicha', price:8},
      {id:'cebcar', name:'Cebolla caramelizada', price:5},
    ];
    const EXTRAS = [
      {id:'carne', name:'Carne extra (85g)', price:27},
    ];

    // --- Estado UI ---
    let currentUser = null; // {id,name,role,mesas:[]}
    let mesas = []; // [{id,name}]
    let users = []; // [{id,name,role,pin}]
    let pricesVisible = true;

    // --- Helpers ---
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    const peso = v => `$${Number(v).toFixed(0)}`;
    const byId = id => document.getElementById(id);

    function setTab(id){
      $$('#tabs .tab').forEach(b=>b.setAttribute('aria-selected', String(b.dataset.tab===id)));
      $$('main section').forEach(s=>s.classList.remove('active'));
      byId(id).classList.add('active');
      if(id==='kiosko') updateMesaHint();
    }

    // Tabs
    $$('#tabs .tab').forEach(btn=>{
      if(btn.id==='loginBtn') return;
      btn.addEventListener('click', ()=> setTab(btn.dataset.tab));
    });

    // Login
    byId('loginBtn').addEventListener('click', ()=> $('#loginModal').classList.add('active'));
    byId('cancelLogin').addEventListener('click', ()=> $('#loginModal').classList.remove('active'));
    byId('doLogin').addEventListener('click', async ()=>{
      const role = byId('loginRole').value;
      const pin  = byId('loginPin').value.trim();
      if(!pin){alert('PIN requerido');return}
      // Busca usuario
      let found = users.find(u=>u.pin===pin && u.role===role);
      if(!found && pin==='1234'){ // bootstrap
        await addDoc(collection(db,'users'), {name:'Admin', role:'admin', pin:'1234', mesas:[], active:true, createdAt:serverTimestamp()});
        await loadUsers(); found = users.find(u=>u.pin==='1234');
      }
      if(!found){alert('Usuario o PIN inválido');return}
      currentUser = found;
      $('#loginModal').classList.remove('active');
      byId('whoami').textContent = `${currentUser.name} · ${currentUser.role}`;
      if(role==='mesero') setTab('mesero');
      if(role==='cocina') setTab('cocina');
      if(role==='admin')  setTab('admin');
      renderWaiterMenu();
    });

    // Seed demo
    byId('seedData').addEventListener('click', async()=>{
      if(!confirm('Cargar datos de demo (mesas y usuarios)?')) return;
      // mesas
      for(const n of [1,2,3,4]){
        await setDoc(doc(collection(db,'mesas'), String(n)), {name:String(n), active:true, createdAt:serverTimestamp()});
      }
      // usuarios
      await addDoc(collection(db,'users'), {name:'Alex', role:'mesero', pin:'1111', mesas:[1,2], active:true, createdAt:serverTimestamp()});
      await addDoc(collection(db,'users'), {name:'Cocina', role:'cocina', pin:'2222', mesas:[], active:true, createdAt:serverTimestamp()});
      await addDoc(collection(db,'users'), {name:'Admin', role:'admin', pin:'1234', mesas:[], active:true, createdAt:serverTimestamp()});
      alert('Listo. Recarga para verlos.');
    });

    // Admin: mesas
    byId('addMesa').addEventListener('click', async ()=>{
      const name = byId('newMesa').value.trim();
      if(!name) return;
      await addDoc(collection(db,'mesas'), {name, active:true, createdAt:serverTimestamp()});
      byId('newMesa').value='';
    });

    // Admin: users
    byId('addUser').addEventListener('click', async ()=>{
      const name = byId('uNombre').value.trim();
      const role = byId('uRol').value;
      const pin  = byId('uPin').value.trim();
      if(!name || !pin) return alert('Nombre y PIN');
      await addDoc(collection(db,'users'), {name, role, pin, mesas:[], active:true, createdAt:serverTimestamp()});
      byId('uNombre').value=''; byId('uPin').value='';
    });

    // Settings toggles
    byId('pricesVisible').addEventListener('change', e=>{
      pricesVisible = e.target.checked;
      renderKiosk();
      persistSetting('pricesVisible', pricesVisible);
    });
    byId('autoComplete').addEventListener('change', e=>{
      persistSetting('autoComplete', e.target.checked);
    });

    // Mesa param hint
    function updateMesaHint(){
      const mesaParam = new URLSearchParams(location.search).get('mesa');
      byId('mesaHint').textContent = 'Mesa: ' + (mesaParam ?? '—');
    }

    // Persist simple settings in Firestore doc (singleton)
    async function persistSetting(k,v){
      await setDoc(doc(db,'settings','global'), {[k]:v},{merge:true});
    }
    onSnapshot(doc(db,'settings','global'), snap=>{
      const s = snap.data()||{};
      if(typeof s.pricesVisible==='boolean'){ pricesVisible = s.pricesVisible; byId('pricesVisible').checked = pricesVisible; renderKiosk(); }
    });

    // Cargar Mesas/Usuarios en tiempo real
    async function loadUsers(){
      const qs = await getDocs(collection(db,'users'));
      users = qs.docs.map(d=>({id:d.id, ...d.data()}));
      renderUsers();
    }
    onSnapshot(collection(db,'mesas'), snap=>{
      mesas = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(m=>m.active!==false);
      renderMesas();
      renderKiosk();
    });
    loadUsers();

    // Render Mesas + select Mesero
    function renderMesas(){
      const list = byId('mesasList');
      list.innerHTML = '';
      mesas.sort((a,b)=> (a.name+'').localeCompare(b.name+''));
      mesas.forEach(m=>{
        const row = document.createElement('div'); row.className='li';
        row.innerHTML = `<div>🪑 Mesa <b>${m.name}</b></div>
          <div class="row">
            <button class="btn secondary" data-del="${m.id}">Eliminar</button>
          </div>`;
        row.querySelector('[data-del]').onclick = ()=> deleteDoc(doc(db,'mesas',m.id));
        list.appendChild(row);
      });
      // select
      const sel = byId('mesaSelect');
      sel.innerHTML = '<option value="">— Mesa —</option>' + mesas.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
    }

    // Render Users
    function renderUsers(){
      const list = byId('usersList'); list.innerHTML='';
      users.forEach(u=>{
        const row = document.createElement('div'); row.className='li';
        row.innerHTML = `<div>👤 <b>${u.name}</b> · ${u.role} <span class="muted">PIN ${u.pin}</span></div>
        <div class="row"><button class="btn secondary" data-del="${u.id}">Eliminar</button></div>`;
        row.querySelector('[data-del]').onclick = ()=> deleteDoc(doc(db,'users',u.id));
        list.appendChild(row);
      });
    }

    // --- KIOSKO ---
    function renderKioskCard(b){
      const priceTxt = pricesVisible ? `<span class="price">${peso(b.price)}</span>` : '';
      const ingr = b.ingredients.slice(0,5).join(' • ') + '…';
      return `<div class="card">
        <div class="row"><h3><span class="ico i-burger"></span>${b.name}</h3>${priceTxt}</div>
        <div class="muted" style="min-height:40px">${ingr}</div>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-order="${b.id}">Ordenar</button>
          <button class="btn secondary" data-info="${b.id}">Ingredientes</button>
        </div>
      </div>`;
    }
    function renderKiosk(){
      const box = byId('kioskList'); box.innerHTML = BURGERS.map(renderKioskCard).join('');
      box.querySelectorAll('[data-info]').forEach(btn=>{
        btn.onclick = ()=> showInfo(btn.dataset.info, 'kiosk');
      });
      box.querySelectorAll('[data-order]').forEach(btn=>{
        btn.onclick = ()=> openOrderModal(btn.dataset.order, 'kiosk');
      });
    }
    renderKiosk();

    // --- MESERO ---
    byId('misMesasBtn').addEventListener('click', ()=>{
      if(!currentUser){alert('Inicia sesión'); return}
      renderWaiterMenu(true);
    });
    function renderWaiterMenu(onlyMine=false){
      const box = byId('waiterList'); box.innerHTML='';
      const mesa = byId('mesaSelect').value || new URLSearchParams(location.search).get('mesa') || '';
      BURGERS.forEach(b=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row"><h3>${b.name}</h3><span class="price">${peso(b.price)}</span></div>
          <div class="muted" style="min-height:40px">${b.ingredients.join(' • ')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-order="${b.id}">Enviar a cocina</button>
            <button class="btn secondary" data-info="${b.id}">Ingredientes</button>
          </div>
        `;
        card.querySelector('[data-info]').onclick = ()=> showInfo(b.id, 'mesero');
        card.querySelector('[data-order]').onclick = ()=> openOrderModal(b.id, 'mesero', {mesa});
        box.appendChild(card);
      });
    }

    // Info
    function showInfo(id, ctx){
      const b = BURGERS.find(x=>x.id===id);
      const html = `
        <h2>${b.name} <span class="price">${peso(b.price)}</span></h2>
        <div class="muted">Ingredientes: ${b.ingredients.join(' • ')}</div>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="omOrder">Ordenar</button>
          <button class="btn secondary" id="omClose">Cerrar</button>
        </div>`;
      byId('orderSheet').innerHTML = html;
      $('#orderModal').classList.add('active');
      byId('omClose').onclick = ()=> $('#orderModal').classList.remove('active');
      byId('omOrder').onclick = ()=> { $('#orderModal').classList.remove('active'); openOrderModal(id, ctx); }
    }

    // Order modal (kiosko/mesero)
    function openOrderModal(id, ctx, opts={}){
      const mesaParam = opts.mesa || new URLSearchParams(location.search).get('mesa') || '';
      const b = BURGERS.find(x=>x.id===id);
      const adz = ADEREZOS.map(a=>`<label class="switch"><input type="checkbox" data-adz="${a.id}" data-p="${a.price}">${a.name} <span class="muted">(+${peso(a.price)})</span></label>`).join('');
      const exs = EXTRAS.map(a=>`<label class="switch"><input type="checkbox" data-ex="${a.id}" data-p="${a.price}">${a.name} <span class="muted">(+${peso(a.price)})</span></label>`).join('');
      const sin  = ['Lechuga','Jitomate','Cebolla','Mayonesa','Cátsup','Mostaza'].map(x=>`<label class="switch"><input type="checkbox" data-sin="${x}">Sin ${x}</label>`).join('');

      const html = `
        <h2>${b.name} · <span class="price">${peso(b.price)}</span></h2>
        <div class="muted">Salsa sugerida: <b>${b.suggested}</b></div>
        <div class="row" style="gap:8px; margin:.4rem 0">
          <input id="omNombre" placeholder="Nombre del cliente">
          <input id="omMesa" placeholder="Mesa" value="${mesaParam||''}" style="max-width:140px">
        </div>
        <details open class="card" style="margin:.4rem 0">
          <summary><b>Aderezos extra (opcionales)</b></summary>
          <div class="list" style="margin-top:8px">${adz}</div>
          <label class="switch" style="margin-top:8px"><input type="checkbox" id="surprise"> ¿Te sorprendemos con un aderezo? (+$5)</label>
        </details>
        <details class="card" style="margin:.4rem 0">
          <summary><b>Extras</b></summary>
          <div class="list" style="margin-top:8px">${exs}</div>
        </details>
        <details class="card" style="margin:.4rem 0">
          <summary><b>Quitar ingredientes</b></summary>
          <div class="row-wrap" style="margin-top:8px">${sin}</div>
        </details>
        <textarea id="omNotas" rows="2" placeholder="Notas a cocina (ej. sin jitomate, pan extra dorado)"></textarea>
        <div class="row" style="margin-top:10px">
          <div id="omTotal" class="price">${peso(b.price)}</div>
          <span class="muted" id="omDetail"></span>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="omSend">${ctx==='kiosk'?'Enviar pedido':'Enviar a cocina'}</button>
          <button class="btn secondary" id="omCancel">Cancelar</button>
        </div>
      `;
      byId('orderSheet').innerHTML = html;
      $('#orderModal').classList.add('active');
      byId('omCancel').onclick = ()=> $('#orderModal').classList.remove('active');

      function calc(){
        let total = b.price, parts=[];
        $$('#orderSheet input[type=checkbox][data-adz]').forEach(ch=>{ if(ch.checked){ total += Number(ch.dataset.p); parts.push(ch.parentElement.textContent.trim()) }});
        $$('#orderSheet input[type=checkbox][data-ex]').forEach(ch=>{ if(ch.checked){ total += Number(ch.dataset.p); parts.push(ch.parentElement.textContent.trim()) }});
        if(byId('surprise')?.checked){ total += 5; parts.push('Sorpresa +$5'); }
        byId('omTotal').textContent = peso(total);
        byId('omDetail').textContent = parts.join(' • ');
      }
      byId('orderSheet').addEventListener('change', e=>{ if(e.target.matches('input[type=checkbox]')) calc(); });
      calc();

      byId('omSend').onclick = async ()=>{
        const nombre = byId('omNombre').value.trim();
        const mesa   = byId('omMesa').value.trim() || '—';
        const notas  = byId('omNotas').value.trim();
        const adzSel = [...$$('#orderSheet input[data-adz]:checked')].map(x=>{
          const id=x.dataset.adz; const meta=ADEREZOS.find(a=>a.id===id);
          return {id, name:meta.name, price:Number(x.dataset.p)};
        });
        const exSel = [...$$('#orderSheet input[data-ex]:checked')].map(x=>{
          const id=x.dataset.ex; const meta=EXTRAS.find(a=>a.id===id);
          return {id, name:meta.name, price:Number(x.dataset.p)};
        });
        const sinSel = [...$$('#orderSheet input[data-sin]:checked')].map(x=>x.dataset.sin);
        const total = Number(byId('omTotal').textContent.replace('$',''));

        const docData = {
          ctx, mesa, customer:nombre||null,
          burger:{id:b.id, name:b.name, basePrice:b.price, ingredients:b.ingredients, suggested:b.suggested},
          extras: exSel,
          addOns: adzSel,
          surprise: byId('surprise')?.checked || false,
          remove: sinSel,
          notes: notas || null,
          price: total,
          status:'pendiente',
          createdAt: serverTimestamp(),
          meseroId: currentUser?.id || null,
          mesero: currentUser?.name || 'Kiosko'
        };
        await addDoc(collection(db,'orders'), docData);
        $('#orderModal').classList.remove('active');
        alert('¡Pedido enviado!');
      };
    }

    // --- Cocina realtime ---
    const kitchenQ = query(collection(db,'orders'), orderBy('createdAt','desc'));
    onSnapshot(kitchenQ, snap=>{
      const showDone = byId('showDone').checked;
      const list = byId('kitchenList'); list.innerHTML='';
      snap.docs.forEach(d=>{
        const o = {id:d.id, ...d.data()};
        if(!showDone && o.status==='entregado') return;
        const statusBadge = {
          pendiente:'status s-pend',
          preparando:'status s-prep',
          listo:'status s-ready',
          entregado:'status s-done'
        }[o.status] || 'status s-pend';

        const ing = (o.burger?.ingredients||[])
          .filter(x=>!o.remove?.includes(x))
          .join(' • ');

        const adz = (o.addOns||[]).map(a=>a.name).join(' • ');
        const exs = (o.extras||[]).map(a=>a.name).join(' • ');

        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row">
            <h3>${o.burger?.name||'—'}</h3>
            <span class="${statusBadge}">${o.status}</span>
          </div>
          <div class="muted">Mesa: <b>${o.mesa||'—'}</b> · ${o.customer?('Cliente: <b>'+o.customer+'</b>'):''}</div>
          <div class="muted" style="margin-top:6px"><b>Ingredientes:</b> ${ing || '—'}</div>
          ${adz?`<div class="muted"><b>Aderezos:</b> ${adz}</div>`:''}
          ${exs?`<div class="muted"><b>Extras:</b> ${exs}</div>`:''}
          ${o.surprise?`<div class="muted"><b>Sorpresa:</b> 1 aderezo a elección del chef</div>`:''}
          ${o.remove?.length?`<div class="muted"><b>Quitar:</b> ${o.remove.join(' • ')}</div>`:''}
          ${o.notes?`<div class="muted"><b>Notas:</b> ${o.notes}</div>`:''}
          <div class="row" style="margin-top:8px">
            ${o.status!=='preparando'?'<button class="btn" data-act="preparando">Preparar</button>':''}
            ${o.status!=='listo'?'<button class="btn ok" data-act="listo">Listo</button>':''}
            <button class="btn warn" data-act="entregado">Entregar</button>
          </div>
        `;
        card.querySelectorAll('[data-act]').forEach(b=>{
          b.onclick = ()=> updateDoc(doc(db,'orders',o.id), {status:b.dataset.act});
        });
        list.appendChild(card);
      });
    });
    byId('showDone').addEventListener('change', ()=>{});

    // Default to kiosko tab on load
    setTab('kiosko');
  </script>
</body>
</html>
