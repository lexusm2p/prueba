<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="../shared/styles.css"/>
  <title>Admin — Seven de Burgers</title>

  <!-- Estilos locales del admin (incluye la lista de temas) -->
  <style>
    /* === ENLACE CON EL SISTEMA DE TEMAS ===
       Forzamos a usar las variables que setea /shared/theme.js
       para que cambien tipografías y colores al aplicar un tema. */
    html, body{
      background-color: var(--bg, #0b0f14);
      color: var(--text, #e8f0ff);
      font-family: var(--font-base, Inter, system-ui, Arial);
    }
    /* Usa la display del tema en títulos / marcas */
    h1, h2, h3, .brand div:first-child, .title-sub, .display-font{
      font-family: var(--font-display, inherit);
    }

    /* Tabs / paneles */
    .tabs-admin{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tabs-admin .tab{ padding:10px 12px; border-radius:12px; border:2px solid #2a3347; background:#121a2a; color:#eaf2ff; cursor:pointer; }
    .tabs-admin .tab.is-active{ border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 15%, transparent) inset; }
    .panel{ display:none; }
    .panel.active{ display:block; }

    /* Tablas */
    .k-table{ width:100%; border-collapse:collapse; font-size:14px }
    .k-table th,.k-table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08) }
    .k-table th{ text-align:left; color:var(--muted) }
    .k-badge.ok{ background:#183a2a } .k-badge.warn{ background:#3a2f18 }
    .table-wrap { overflow:auto; -webkit-overflow-scrolling: touch; }
    .k-table th, .k-table td { white-space: nowrap; }
    @media (max-width:480px){ #tblHist th:nth-child(4), #tblHist td:nth-child(4){ display:none; } }

    /* ---------- Lista de Temas (antidesborde) ---------- */
    .theme-list{
      list-style:none; padding:0; margin:0;
      display:grid; gap:10px;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .theme-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:2px solid rgba(255,255,255,.18);
      background:#121a2a; border-radius:12px;
      min-width:0;
    }
    .theme-item .dot{
      width:14px; height:14px; border-radius:4px;
      background:var(--accent); box-shadow:0 0 10px var(--accent);
      flex:0 0 auto;
    }
    .theme-item .title{
      font-size:14px; line-height:1.2; color:#eaf2ff;
      min-width:0; flex:1 1 auto;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden; text-overflow:ellipsis; word-break:break-word;
      /* Se ve la display font del tema en los títulos de la lista */
      font-family: var(--font-display, inherit);
    }
    .theme-item .btn{ flex:0 0 auto; white-space:nowrap; }
    .theme-item.is-active{ border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 12%, transparent) inset; }
    @media (max-width:520px){
      .theme-list{ grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; }
      .theme-item .btn.small{ padding:8px 10px; }
    }
  </style>
</head>
<body>
<header class="header">
  <div class="brand"><span class="dot"></span>
    <div><div class="display-font">Seven de Burgers</div><div class="title-sub">Admin</div></div>
  </div>
  <nav class="row" style="gap:8px">
    <a class="btn ghost small" href="../kiosk/">Kiosko</a>
    <a class="btn ghost small" href="../cocina/">Cocina</a>
    <a class="btn ghost small" href="../mesero/">Mesero</a>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h2 class="display-font">Panel de administración</h2>

    <div class="tabs-admin" id="admTabs" role="tablist" aria-label="Módulos de Admin">
      <button class="tab is-active" data-tab="reportes" role="tab" aria-selected="true">Reportes</button>
      <button class="tab" data-tab="hist" role="tab" aria-selected="false">Historial</button>
      <button class="tab" data-tab="cobros" role="tab" aria-selected="false">Cobros</button>
      <button class="tab" data-tab="compras" role="tab" aria-selected="false">Compras</button>
      <button class="tab" data-tab="inventario" role="tab" aria-selected="false">Inventario</button>
      <button class="tab" data-tab="proveedores" role="tab" aria-selected="false">Proveedores</button>
      <button class="tab" data-tab="productos" role="tab" aria-selected="false">Productos / Combos</button>
      <button class="tab" data-tab="temas" role="tab" aria-selected="false">Temas</button>
      <button class="tab" data-tab="happy" role="tab" aria-selected="false">Happy Hour</button>
      <button class="tab" data-tab="recetas" role="tab" aria-selected="false">Recetario</button>
      <button class="tab" data-tab="articulos" role="tab" aria-selected="false">Artículos</button>
    </div>

    <!-- REPORTES -->
    <section class="panel active" id="panel-reportes">
      <h3 class="display-font">Reportes de ventas</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
        <div class="field"><label>Desde</label><input id="repFrom" type="date"/></div>
        <div class="field"><label>Hasta</label><input id="repTo" type="date"/></div>
        <div class="field"><label>Tipo de pedido</label>
          <select id="repType"><option value="all">Todos</option><option value="pickup">Pickup</option><option value="dinein">Mesa</option></select>
        </div>
        <div class="field"><label>Incluir archivo histórico</label>
          <select id="repHist"><option>Sí</option><option>No</option></select>
        </div>
        <div class="field" style="align-self:end"><button class="btn" id="btnRepGen">Generar</button></div>
      </div>

      <div class="grid" style="margin-top:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div class="k-card"><div class="muted small">Órdenes</div><div id="kpiOrders" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Artículos vendidos</div><div id="kpiUnits" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Ingresos</div><div id="kpiRevenue" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Ticket promedio</div><div id="kpiAvg" class="price">$0</div></div>
      </div>

      <h4 style="margin-top:16px">Top productos</h4>
      <table class="k-table" id="tblTop"><thead><tr><th>Producto</th><th>Unidades</th><th>Ingresos</th></tr></thead><tbody></tbody></table>

      <h4 style="margin-top:16px">Productos de baja rotación</h4>
      <table class="k-table" id="tblLow"><thead><tr><th>Producto</th><th>Unidades</th><th>Ingresos</th></tr></thead><tbody></tbody></table>

      <h4 style="margin-top:16px">Ventas por hora</h4>
      <table class="k-table" id="tblHours"><thead><tr><th>Hora</th><th>Órdenes</th><th>Ingresos</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- HISTORIAL -->
    <section class="panel" id="panel-hist">
      <h3 class="display-font">Historial de pedidos</h3>

      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
        <div class="field"><label>Búsqueda (nombre / teléfono / ID)</label><input id="histSearch" type="search" placeholder="Buscar…"></div>
        <div class="field"><label>Tipo</label>
          <select id="histType"><option value="all">Todos</option><option value="pickup">Pickup</option><option value="dinein">Mesa</option></select>
        </div>
        <div class="field"><label>Estado</label>
          <select id="histState">
            <option value="all">Todos</option>
            <option value="PENDING">PENDING</option>
            <option value="COOKING">COOKING</option>
            <option value="READY">READY</option>
            <option value="CHARGED">CHARGED</option>
            <option value="CANCELLED">CANCELLED</option>
          </select>
        </div>
        <div class="field"><label>Límite</label><input id="histLimit" type="number" min="10" step="10" value="50"></div>
        <div class="field" style="align-self:end">
          <div class="row" style="gap:8px">
            <button id="btnHistLoad" class="btn">Cargar</button>
            <button id="btnHistCSV" class="btn ghost">Exportar CSV</button>
          </div>
          <div class="muted small" style="margin-top:6px">* Usa “Desde/Hasta” y “Incluir archivo histórico” del panel Reportes.</div>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:8px;">
        <table id="tblHist" class="k-table">
          <thead>
            <tr><th>Fecha</th><th>Cliente</th><th>Tipo</th><th>Artículos</th><th>Total</th><th>Estado</th><th></th></tr>
          </thead>
          <tbody><tr><td colspan="7">—</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- COBROS -->
    <section class="panel" id="panel-cobros">
      <h3 class="display-font">Cobros</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
        <div class="field"><label>Desde</label><input id="cobFrom" type="date"/></div>
        <div class="field"><label>Hasta</label><input id="cobTo" type="date"/></div>
        <div class="field"><label>Tipo de pedido</label>
          <select id="cobType"><option value="all">Todos</option><option value="pickup">Pickup</option><option value="dinein">Mesa</option></select>
        </div>
        <div class="field" style="align-self:end"><button class="btn" id="btnCobrosRefresh">Actualizar</button></div>
      </div>

      <h4 style="margin-top:16px">Por cobrar (en vivo)</h4>
      <table class="k-table" id="tblPorCobrar">
        <thead>
          <tr><th>Fecha</th><th>Cliente</th><th>Tipo</th><th class="right">Total</th><th>Pref. pago</th><th class="right">Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="grid" style="margin-top:16px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div class="k-card"><div class="muted small">Cobros (registros)</div><div id="kpiCobrosCount" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Total cobrado</div><div id="kpiCobrosTotal" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Efectivo</div><div id="kpiCobrosEfe" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Tarjeta</div><div id="kpiCobrosTar" class="price">$0</div></div>
        <div class="k-card"><div class="muted small">Transferencia</div><div id="kpiCobrosTrans" class="price">$0</div></div>
      </div>

      <h4 style="margin-top:16px">Historial de cobros</h4>
      <table class="k-table" id="tblCobrosHist">
        <thead>
          <tr><th>Fecha cobro</th><th>Cliente</th><th>Tipo</th><th class="right">Total cobrado</th><th>Método</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- COMPRAS -->
    <section class="panel" id="panel-compras">
      <h3 class="display-font">Compras</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
        <div class="field"><label>Ingrediente</label><input id="pName" type="text"></div>
        <div class="field"><label>Cantidad comprada (unid/kg/l)</label><input id="pQty" type="number" min="0" step="0.01"></div>
        <div class="field"><label>Costo total</label><input id="pCost" type="number" min="0" step="0.01"></div>
        <div class="field"><label>Proveedor (opcional)</label><input id="pVendor" type="text" placeholder="id proveedor o nombre"></div>
        <div class="field" style="align-self:end"><button class="btn" id="btnAddPurchase">Registrar compra</button></div>
      </div>
      <div class="muted small">* Guarda en <b>purchases</b> y actualiza <b>inventory</b> con costo promedio.</div>

      <h4 style="margin-top:16px">Últimas compras</h4>
      <table class="k-table" id="tblPurch"><thead><tr><th>Fecha</th><th>Ingrediente</th><th>Cant.</th><th>Costo</th><th>Proveedor</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- INVENTARIO -->
    <section class="panel" id="panel-inventario">
      <h3 class="display-font">Inventario</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); margin-bottom:6px">
        <div class="field"><label>Buscar</label><input id="invSearch" type="text" placeholder="nombre…"></div>
        <div class="field" style="align-self:end"><button class="btn ghost" id="btnInvRefresh">Actualizar</button></div>
      </div>
      <table class="k-table" id="tblInv"><thead><tr><th>Ingrediente</th><th>Existencia</th><th>Um</th><th>Costo prom.</th><th>Valorizado</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- PROVEEDORES -->
    <section class="panel" id="panel-proveedores">
      <h3 class="display-font">Proveedores</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
        <div class="field"><label>Nombre</label><input id="vName" type="text"></div>
        <div class="field"><label>Contacto</label><input id="vContact" type="text" placeholder="tel / mail / nota"></div>
        <div class="field" style="align-self:end"><button class="btn" id="btnSaveVendor">Guardar</button></div>
      </div>
      <table class="k-table" id="tblVendors"><thead><tr><th>Nombre</th><th>Contacto</th><th>ID</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- PRODUCTOS / COMBOS -->
    <section class="panel" id="panel-productos">
      <h3 class="display-font">Productos / Combos</h3>
      <div class="muted">WIP — Aquí podrás crear/editar productos, fijar precios y armar combos. El kiosko lee directo de <b>products</b>.</div>
      <div class="field" style="margin-top:10px"><button class="btn ghost" id="btnReloadCatalog">Refrescar catálogo del kiosko</button></div>
      <table class="k-table" id="tblProducts"><thead><tr><th>Nombre</th><th>Tipo</th><th>Precio</th><th>Activo</th><th>ID</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- TEMAS -->
    <section class="panel" id="panel-temas">
      <h3 class="display-font">Temas (Kiosko/UI)</h3>
      <p class="muted small">Selecciona un tema para previsualizarlo localmente. “Guardar GLOBAL” escribe en <code>settings/theme</code>.</p>

      <ul class="theme-list" id="themeList">
        <li class="theme-item" data-theme="Base"><span class="dot"></span><span class="title">Base</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Independencia"><span class="dot"></span><span class="title">Independencia</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Día de Muertos"><span class="dot"></span><span class="title">Día de Muertos</span><button class="btn small ghost">Previsualizar</button></li>
        <!-- IMPORTANTE: usar el nombre exacto del preset -->
        <li class="theme-item" data-theme="Navidad MX"><span class="dot"></span><span class="title">Navidad MX</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Halloween"><span class="dot"></span><span class="title">Halloween</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Fútbol"><span class="dot"></span><span class="title">Fútbol</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Lucha Libre"><span class="dot"></span><span class="title">Lucha Libre</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Pixel Art"><span class="dot"></span><span class="title">Pixel Art</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Retro Arcade"><span class="dot"></span><span class="title">Retro Arcade</span><button class="btn small ghost">Previsualizar</button></li>
        <li class="theme-item" data-theme="Y2K (90s/00s)"><span class="dot"></span><span class="title">Y2K (90s/00s)</span><button class="btn small ghost">Previsualizar</button></li>
      </ul>

      <div class="row" style="margin-top:16px; justify-content:flex-end; gap:8px; flex-wrap:wrap">
        <button id="btnPreviewLocal" class="btn small">Probar local</button>
        <button id="btnGuardarGlobal" class="btn small warn">Guardar GLOBAL</button>
      </div>

      <div class="muted small" style="margin-top:10px">
        * “Probar local” aplica el tema solo en este navegador (no guarda).<br>
        * “Guardar GLOBAL” escribe en <b>settings/theme</b>; los kioskos lo aplican en vivo.
      </div>
    </section>

    <!-- HAPPY HOUR -->
    <section class="panel" id="panel-happy">
      <h3 class="display-font">Happy Hour</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px">
        <div class="field"><label>Estado</label><select id="hhEnabled"><option value="off">Desactivada</option><option value="on">Activada</option></select></div>
        <div class="field"><label>Descuento general (%)</label><input id="hhDisc" type="number" min="0" max="90" value="0"></div>
        <div class="field"><label>Mensaje en kiosko</label><input id="hhMsg" type="text" placeholder="Ej. 2x1 en Minis 7–8 pm"></div>
        <div class="field" style="align-self:end"><button class="btn" id="btnSaveHappy">Guardar</button></div>
        <div class="field"><label>Duración (min)</label><input id="hhDurMin" type="number" min="0" step="5" placeholder="Ej. 60"><div class="muted small">Si indicas duración y está activada, se calcula el fin automáticamente.</div></div>
        <div class="field"><label>Termina el</label><input id="hhEndsAt" type="datetime-local"><div class="muted small">Si no pones duración, puedes definir fecha/hora de término.</div></div>
        <div class="field"><label>Estado / Cuenta regresiva</label><div id="hhCountdown" class="muted small">Inactivo</div></div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn ghost" id="btnHH30">Iniciar 30 min</button>
        <button class="btn ghost" id="btnHH60">Iniciar 60 min</button>
        <button class="btn ghost" id="btnHH90">Iniciar 90 min</button>
        <button class="btn ghost" id="btnHHExtend15">Extender +15 min</button>
        <button class="btn danger" id="btnHHStop">Detener</button>
      </div>
      <div class="muted small" style="margin-top:8px">* Guarda en <b>settings/happyHour</b>. El kiosko lo muestra y aplica el descuento si corresponde.</div>
      <h4 style="margin-top:16px">Reglas específicas</h4>
      <div class="muted small">WIP — podrás seleccionar productos/combos con descuento exclusivo durante HH.</div>
    </section>

    <!-- RECETARIO -->
    <section class="panel" id="panel-recetas">
      <h3 class="display-font">Recetario de aderezos</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-bottom:8px">
        <div class="field"><label>Buscar</label><input id="rcpSearch" type="text" placeholder="nombre o ingrediente…"></div>
        <div class="field"><label>Porción rápida</label>
          <select id="rcpQuickPort">
            <option value="500">500 ml</option>
            <option value="250">250 ml</option>
            <option value="200">200 ml</option>
            <option value="100" selected>100 ml</option>
          </select>
        </div>
      </div>
      <table class="k-table" id="tblRecipes"><thead><tr><th>Receta</th><th>Rinde base</th><th>Producto terminado</th><th>#Ingr.</th><th></th></tr></thead><tbody></tbody></table>
    </section>

    <!-- Modal Receta -->
    <div class="modal small" id="rcpModal" role="dialog" aria-modal="true" aria-labelledby="rcpTitle" style="display:none">
      <div class="modal-card">
        <div class="modal-head">
          <div id="rcpTitle" class="display-font">Receta</div>
          <button class="btn ghost small" id="rcpClose" aria-label="Cerrar">Cerrar</button>
        </div>
        <div class="modal-body" id="rcpBody"></div>
        <div class="modal-foot">
          <div class="total-bar">
            <div class="muted small mono" id="rcpHint"></div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" id="rcpScale500">500 ml</button>
              <button class="btn ghost" id="rcpScale250">250 ml</button>
              <button class="btn ghost" id="rcpScale200">200 ml</button>
              <button class="btn ghost" id="rcpScale100">100 ml</button>
              <button class="btn" id="rcpPrepare">Preparar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ARTÍCULOS CRUD -->
    <section class="panel" id="panel-articulos">
      <h3 class="display-font">Artículos</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px; margin-bottom:8px">
        <div class="field"><label>Buscar</label><input id="artSearch" type="text" placeholder="nombre o descripción…"></div>
        <div class="field" style="align-self:end"><button class="btn" id="btnAddArticulo">Nuevo artículo</button></div>
      </div>
      <table class="k-table" id="tblArticulos">
        <thead><tr><th>Nombre</th><th>Precio</th><th>Activo</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="muted small" style="margin-top:6px">* Haz clic en los encabezados para ordenar.</div>
    </section>

  </div>
</main>

<!-- App principal -->
<script type="module" src="./app.js"></script>

<!-- Temas: integra con /shared/theme.js -->
<script type="module">
  import { applyThemeLocal as applyThemeCore, initThemeFromSettings } from '../shared/theme.js';
  import { db, doc, setDoc } from '../shared/firebase.js';

  // Alias por si alguien usa otra grafía en DB/URL
  const NAME_ALIASES = {
    'navidad': 'Navidad MX',
    'navidad mx': 'Navidad MX',
    'dia de muertos': 'Día de Muertos',
    'día de muertos': 'Día de Muertos',
    'independencia': 'Independencia',
  };
  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const resolveThemeName = (name)=> NAME_ALIASES[norm(name)] || name;

  // Si hay vista previa local previa, úsala; si no, escucha settings/theme
  const stored = sessionStorage.getItem('theme_local');
  if (stored) {
    try { applyThemeCore(resolveThemeName(stored)); } catch {}
  } else {
    try { initThemeFromSettings({ defaultName: 'Base' }); } catch {}
  }

  let selectedTheme = stored || 'Base';

  function applyThemeLocal(name){
    const fixed = resolveThemeName(name);
    applyThemeCore(fixed);
    selectedTheme = fixed;
    sessionStorage.setItem('theme_local', fixed);
    document.querySelectorAll('.theme-item').forEach(x=>{
      x.classList.toggle('is-active', x.dataset.theme === fixed);
    });
  }

  async function saveThemeGlobal(name){
    const fixed = resolveThemeName(name);
    await setDoc(doc(db,'settings','theme'), { name: fixed }, { merge:true });
    alert('Tema guardado GLOBAL: ' + fixed);
  }

  // Interacciones de la lista: click en LI o en el botón "Previsualizar"
  const list = document.getElementById('themeList');
  list?.addEventListener('click', (e)=>{
    const li = e.target.closest('.theme-item');
    if (!li) return;
    applyThemeLocal(li.dataset.theme);
  });

  // Botones de acción
  document.getElementById('btnPreviewLocal')?.addEventListener('click', ()=>{
    if (selectedTheme) applyThemeLocal(selectedTheme);
  });
  document.getElementById('btnGuardarGlobal')?.addEventListener('click', async ()=>{
    if (selectedTheme) await saveThemeGlobal(selectedTheme);
  });
</script>

</body>
</html>
