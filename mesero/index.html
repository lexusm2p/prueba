
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><title>Mesero · Seven de Burgers</title><link rel="stylesheet" href="../assets/styles.css"></head>
<body>
  <div class="header"><div class="logo">🍔 Seven de Burgers <span class="badge">Mesero</span></div><div class="row"><a class="btn secondary" href="../kiosk/index.html">Kiosko</a><button class="btn ghost" id="btnSalir">Salir</button></div></div>
  <div class="container">
    <div class="card"><div class="row"><div><b id="lblMesero">Mesero</b> · Mesa <b id="lblMesa">M1</b></div></div></div>
    <div class="card"><div class="kicker">Órdenes</div><table class="table" id="tbl"><thead><tr><th>Cliente</th><th>Producto</th><th>Cant</th><th>Estatus</th><th></th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="toast" id="toast"></div>
  <script type="module">
    import {subscribeOrders, setStatus, Status} from '../shared/state.smart.js';
    const waiter = JSON.parse(localStorage.getItem('sb_waiter')||'null') || {name:'Mesero', table:'M1'};
    const waiterId = sessionStorage.getItem('sb_mesero_id');
    document.getElementById('lblMesero').textContent = waiter.name; document.getElementById('lblMesa').textContent = waiter.table;
    document.getElementById('btnSalir').addEventListener('click', ()=>{ localStorage.removeItem('sb_role'); location.href='../kiosk/index.html'; });
    const tbody = document.querySelector('#tbl tbody');
    function render(list){
      const mine = list.filter(o => o.table===waiter.table || o.waiterId===waiterId || o.type==='kiosk');
      tbody.innerHTML = mine.map(o=>`<tr><td>${o.customer||'-'}</td><td>${o.burgerName||'-'}</td><td>${o.qty||1}</td><td>${o.status}</td><td>${o.status===Status.READY ? '<button class="btn" data-id="'+o.id+'">Entregar</button>' : ''}</td></tr>`).join('');
      tbody.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click',()=>setStatus(b.dataset.id, Status.DELIVERED)));
    }
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show'); t.style.display='none';}, 2800); }
    subscribeOrders((orders)=>{
      render(orders);
      const now=Date.now();
      orders.filter(o => o.status===Status.READY && (o.table===waiter.table || o.waiterId===waiterId)).forEach(o => { if(now-(o.updatedAt||0)<4000) toast(`Orden lista: ${o.burgerName} · Mesa ${o.table||'-'}`); });
    });
  </script>
  <footer>Backend: <span id="bk">—</span></footer>
  <script type="module">import {backendName} from '../shared/state.smart.js'; document.getElementById('bk').textContent=backendName;</script>
</body></html>
