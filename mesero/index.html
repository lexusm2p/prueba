<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Mesero ¬∑ Seven de Burgers</title>
  <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
  <div class="header">
    <div class="logo">üçî Seven de Burgers <span class="badge">Mesero</span></div>
    <div class="row">
      <a class="btn secondary" href="../kiosk/index.html">Kiosko</a>
      <button class="btn ghost" id="btnLogout">Salir</button>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <div class="kicker">Mi mesa</div>
      <h3 id="lblMesa">‚Äî</h3>
      <div class="row">
        <button class="btn" id="btnNueva">Nueva orden</button>
      </div>
    </div>

    <div class="card">
      <div class="kicker">Mis √≥rdenes</div>
      <table class="table" id="tbl">
        <thead><tr><th>Cliente</th><th>Producto</th><th>Cant</th><th>Estatus</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de alta reutiliza el de kiosko, embebido via iframe para simplicidad -->
  <div class="modal-backdrop" id="backdrop"></div>
  <div class="modal" id="mdlOrden">
    <header><strong>Nueva orden</strong><button class="btn ghost" id="mClose">Cerrar</button></header>
    <div class="content">
      <iframe id="kioskFrame" src="../kiosk/index.html" style="width:100%;height:60vh;border:none;border-radius:12px;background:#061a2b"></iframe>
      <p class="small">Tip: usa el kiosko para armar la orden del cliente y finaliza aqu√≠.</p>
    </div>
    <footer><span></span><button class="btn secondary" id="mDone">Listo</button></footer>
  </div>

  <script type="module">
    import {Auth} from '../shared/auth.js';
    import {Storage} from '../shared/storage.js';
    if(Auth.role!=='mesero'){ location.replace('../login/index.html'); }

    const waiter = Auth.waiter || {name:'Mesero', table:'M1'};
    document.getElementById('lblMesa').textContent = waiter.name + ' ¬∑ ' + waiter.table;

    document.getElementById('btnLogout').addEventListener('click', ()=>Auth.logout());

    const tbody = document.querySelector('#tbl tbody');
    function render(list){
      tbody.innerHTML = list
        .filter(o=>o.type && (o.type==='kiosk' || o.type==='mesero'))
        .filter(o=>!o.waiter || o.waiter===waiter.name || o.table===waiter.table || o.type==='kiosk')
        .map(o=>`<tr>
          <td>${o.customer||'-'}</td>
          <td>${o.burgerName||o.title||'-'}</td>
          <td>${o.qty||1}</td>
          <td>${o.status}</td>
          <td>${o.status==='listo' ? '<button class="btn smallBtn" data-id="'+o.id+'">Entregar</button>' : ''}</td>
        </tr>`).join('');
      tbody.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', ()=> Storage.updateOrder(b.dataset.id, {status:'entregado'}) );
      });
    }
    const unsub = Storage.subscribeOrders(render);

    // Modal kiosk inline
    const backdrop = document.getElementById('backdrop');
    const modal = document.getElementById('mdlOrden');
    function open(){ backdrop.style.display='block'; modal.style.display='block'; }
    function close(){ backdrop.style.display='none'; modal.style.display='none'; }
    document.getElementById('btnNueva').addEventListener('click', open);
    document.getElementById('mClose').addEventListener('click', close);
    document.getElementById('mDone').addEventListener('click', close);
  </script>
</body>
</html>
